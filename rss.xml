<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="rss.xsl"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Notes Blog</title>
        <link>https://dannyjiajia.github.io/</link>
        <description>Notes Blog</description>
        <lastBuildDate>Sat, 22 Feb 2025 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh-Hans</language>
        <item>
            <title><![CDATA[迁移文档到 Docusaurus]]></title>
            <link>https://dannyjiajia.github.io/2025/02/22/hello-docusaurus</link>
            <guid>https://dannyjiajia.github.io/2025/02/22/hello-docusaurus</guid>
            <pubDate>Sat, 22 Feb 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[迁移文档到 Docusaurus,并做一定的配置通过GitHub Workflow自动构建,最后做一定的测试。]]></description>
            <content:encoded><![CDATA[<p>迁移文档到 Docusaurus,并做一定的配置通过<code>GitHub Workflow</code>自动构建,最后做一定的测试。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="github-workflow">GitHub Workflow<a href="https://dannyjiajia.github.io/2025/02/22/hello-docusaurus#github-workflow" class="hash-link" aria-label="GitHub Workflow的直接链接" title="GitHub Workflow的直接链接">​</a></h2>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">.github\workflows\deploy-docusaurus.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deploy to GitHub Pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#22863A">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#22863A">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#22863A">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Review gh actions docs if you want to further define triggers, paths, etc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#22863A">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#22863A">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deploy to GitHub Pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#22863A">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#22863A">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">node-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 16.x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">cache</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yarn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install dependencies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yarn install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">frozen</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">lockfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build slides</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yarn reveal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build website</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> yarn build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Popular action to deploy to GitHub Pages:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Docs: https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-docusaurus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deploy to GitHub Pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> peaceiris/actions</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pages@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">github_token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Build output to publish to the `gh-pages` branch:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">publish_dir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># The following lines assign commit authorship to the official</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># GH-Actions bot for deploys to `gh-pages` branch:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># https://github.com/actions/checkout/issues/13#issuecomment-724415212</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># The GH actions bot is used by default if you didn't specify the two fields.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># You can swap them out with your own user credentials.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">user_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> github</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">actions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">user_email</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 41898282+github</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">actions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">bot</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">@users.noreply.github.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">.github\workflows\deploy.yml</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#22863A">on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#22863A">push</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#22863A">branches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> main </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Change this to your default branch if it's different</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#22863A">jobs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#22863A">deploy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#22863A">runs-on</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#22863A">steps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Checkout code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Setup Node.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">node@v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">node-version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">18</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Use Node.js 18 here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Install dependencies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm install</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Build site</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">run</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> npm run build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#22863A">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deploy to GitHub Pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">uses</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> peaceiris/actions</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">gh</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">pages@v3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#22863A">with</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">github_token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#22863A">publish_dir</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ./build </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Change this if your build output directory is different</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<p>Go to GitHub project setting and click on Page</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[介绍下StorIOSQLite到RxJava]]></title>
            <link>https://dannyjiajia.github.io/2017/think-about-storio</link>
            <guid>https://dannyjiajia.github.io/2017/think-about-storio</guid>
            <pubDate>Fri, 31 Mar 2017 09:46:40 GMT</pubDate>
            <description><![CDATA[storio简介]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="storio简介">storio简介<a href="https://dannyjiajia.github.io/2017/think-about-storio#storio%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="storio简介的直接链接" title="storio简介的直接链接">​</a></h2>
<p><code>storio</code>是github上的<a href="https://github.com/pushtorefresh/storio" target="_blank" rel="noopener noreferrer">开源项目</a>,它用来操作<code>SQLiteDatabase</code>和 <code>ContentResolver</code>的操作进行封装,提供更简单更强大的api.我们项目最近从<code>xutils3</code>转换为<code>StorIOSQLite</code>,说说对它的体验和它是如何使用<code>RxJava</code>进行封装.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resolver操作实体类">Resolver操作实体类<a href="https://dannyjiajia.github.io/2017/think-about-storio#resolver%E6%93%8D%E4%BD%9C%E5%AE%9E%E4%BD%93%E7%B1%BB" class="hash-link" aria-label="Resolver操作实体类的直接链接" title="Resolver操作实体类的直接链接">​</a></h2>
<p>通过<code>SQLiteTypeMapping</code>提供实体的三种<code>Resolver</code>:</p>
<ol>
<li>PutResolver</li>
<li>GetResolver</li>
<li>DeleteResolver</li>
</ol>
<p>也就是分别对应我们在进行API操作时</p>
<ol>
<li>将实体转换为数据库数据(InsertQuery,UpdateQuery...)</li>
<li>将数据库数据(Cursor)装换成实体对象</li>
<li>如何执行删除操作</li>
</ol>
<p>常规的<code>Resolver</code>只要我在实体类中使用它的<code>Annotation Processor</code>便会自动生成。</p>
<blockquote>
<p>什么时候需要自定义呢?</p>
</blockquote>
<p>复杂实体对象的时候(连表查询),因为<code> storio</code>是不关心具体实体类的,它只关心如何将实体和数据库操作建立起关系
比如文档中的<a href="https://github.com/pushtorefresh/storio/blob/master/storio-sample-app/src/main/java/com/pushtorefresh/storio/sample/db/resolvers/UserWithTweetsGetResolver.java" target="_blank" rel="noopener noreferrer">UserWithTweetsGetResolver.java</a></p>
<blockquote>
<p>借鉴xutils利用<code>HashMap</code>来定义通用的读取实体</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">android</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">text</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">TextUtils</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">Date</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">HashMap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">final</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">class</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModel</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     * key: columnName</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     * value: valueStr</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">private</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">HashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#116329">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> dataMap </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">HashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#116329">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">boolean</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getBoolean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> value </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"1"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">equals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Boolean</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">double</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getDouble</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Double</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">float</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getFloat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Float</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">long</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getLong</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Long</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Date</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getDate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">long</span><span class="token plain"> date </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Long</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name namespace" style="color:#116329;opacity:0.7">java</span><span class="token class-name namespace punctuation" style="color:#393A34;opacity:0.7">.</span><span class="token class-name namespace" style="color:#116329;opacity:0.7">sql</span><span class="token class-name namespace punctuation" style="color:#393A34;opacity:0.7">.</span><span class="token class-name" style="color:#116329">Date</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getSqlDate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">long</span><span class="token plain"> date </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Long</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">valueOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name namespace" style="color:#116329;opacity:0.7">java</span><span class="token class-name namespace punctuation" style="color:#393A34;opacity:0.7">.</span><span class="token class-name namespace" style="color:#116329;opacity:0.7">sql</span><span class="token class-name namespace punctuation" style="color:#393A34;opacity:0.7">.</span><span class="token class-name" style="color:#116329">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">date</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> valueStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valueStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     * @return key: columnName</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">HashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">String</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:#116329">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getDataMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> dataMap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     * @param columnName</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">boolean</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">TextUtils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">isEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataMap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">columnName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>提供SQLiteTypeMapping,只提供get操作</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">android</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">database</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">Cursor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">android</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">support</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">annotation</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">NonNull</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pushtorefresh</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">storio</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">sqlite</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">SQLiteTypeMapping</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pushtorefresh</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">storio</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">sqlite</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">StorIOSQLite</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pushtorefresh</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">storio</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">sqlite</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">operations</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">delete</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">DeleteResolver</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pushtorefresh</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">storio</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">sqlite</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">operations</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">delete</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">DeleteResult</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pushtorefresh</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">storio</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">sqlite</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">operations</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">get</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">DefaultGetResolver</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pushtorefresh</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">storio</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">sqlite</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">operations</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">put</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">PutResolver</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">com</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">pushtorefresh</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">storio</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">sqlite</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">operations</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">put</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name" style="color:#116329">PutResult</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic"> * Created by dannyhe on 14/01/2017.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">class</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModelSQLiteTypeMapping</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">SQLiteTypeMapping</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">DbModel</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">class</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DBModelPutResolver</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">PutResolver</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">DbModel</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">PutResult</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">performPut</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">StorIOSQLite</span><span class="token plain"> storIOSQLite</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModel</span><span class="token plain"> object</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">PutResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newUpdateResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">class</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DBModelGetResolver</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DefaultGetResolver</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">DbModel</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModel</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">mapFromCursor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Cursor</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name" style="color:#116329">DbModel</span><span class="token plain"> result </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> columnCount </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">getColumnCount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> columnCount</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#D73A49">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">getColumnName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">getString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">class</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DBModelDeleteResolver</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DeleteResolver</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">DbModel</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DeleteResult</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">performDelete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">StorIOSQLite</span><span class="token plain"> storIOSQLite</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token annotation punctuation" style="color:#393A34">@NonNull</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModel</span><span class="token plain"> object</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DeleteResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModelSQLiteTypeMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DBModelPutResolver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DBModelGetResolver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DBModelDeleteResolver</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>如何使用</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name" style="color:#116329">StorIOSQLite</span><span class="token plain"> mStorIOSQLite </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">  </span><span class="token class-name" style="color:#116329">DefaultStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">sqliteOpenHelper</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dbOpenHelper</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">defaultScheduler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">defaultStorIOSQLiteScheduler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//io thread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">addTypeMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">DbModel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#CF222E">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">DbModelSQLiteTypeMapping</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">build</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name" style="color:#116329">DbModel</span><span class="token plain"> dbModel </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">DbModel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#CF222E">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">withQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">RawQuery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"SELECT COUNT(*) AS c FROM sqlite_master WHERE type=? AND name=?"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">args</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"table"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tableName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">executeAsBlocking</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="entity-vs-cursor">Entity VS Cursor<a href="https://dannyjiajia.github.io/2017/think-about-storio#entity-vs-cursor" class="hash-link" aria-label="Entity VS Cursor的直接链接" title="Entity VS Cursor的直接链接">​</a></h2>
<p><code>storio</code>提供了两种读取方式:</p>
<ol>
<li>Entity</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name" style="color:#116329">DbModel</span><span class="token plain"> dbModel </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">object</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">DbModel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#CF222E">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">withQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">RawQuery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"SELECT COUNT(*) AS c FROM sqlite_master WHERE type=? AND name=?"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">args</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"table"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tableName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">executeAsBlocking</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Cursor</li>
</ol>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">final</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Cursor</span><span class="token plain"> dbModelCursor </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">cursor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">withQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">RawQuery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"SELECT COUNT(*) AS c FROM sqlite_master WHERE type=? AND name=?"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">args</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"table"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tableName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">executeAsBlocking</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rxjava-vs-executeasblocking">RxJava VS executeAsBlocking<a href="https://dannyjiajia.github.io/2017/think-about-storio#rxjava-vs-executeasblocking" class="hash-link" aria-label="RxJava VS executeAsBlocking的直接链接" title="RxJava VS executeAsBlocking的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="理解rxbus">理解RxBus<a href="https://dannyjiajia.github.io/2017/think-about-storio#%E7%90%86%E8%A7%A3rxbus" class="hash-link" aria-label="理解RxBus的直接链接" title="理解RxBus的直接链接">​</a></h3>
<p>关于<code>RxJava</code>的应用(<code>asRxObservable()</code>),目前数据库框架基本上都是利用<code>PublishSubject</code>.每个<code>StorIOSQLite</code>内部有个<code>RxChangesBus</code>,所有的<code>asRxObservable()</code>方法都是订阅这个bus.
订阅时会对Bus的事件过滤,只留下这次查询需要的变化(通过数据表的名称过滤)生成Observable.并通过<code>startWith</code>插入一次查询的结果,用来解决订阅时没有事件源触发查询操作的问题.</p>
<p>我们来分析下面的查询<code>StorIOSQLite</code>到底做了什么,下面的查询来自官网的文档:
我们先按着链式阅读来理解这个方法</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mStorIOSQLite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">listOfObjects</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">Tweet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#CF222E">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">withQuery</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">Query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">table</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"tweets"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">prepare</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">asRxObservable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Get Result as rx.Observable and subscribe to further updates of tables from Query!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">observeOn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">mainThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// All Rx operations work on Schedulers.io()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tweets </span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// Please don't forget to unsubscribe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// will be called with first result and then after each change of tables from Query</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// several changes in transaction -&gt; one notification</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      adapter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">setData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tweets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">// don't forget to manage Subscription and unsubscribe in lifecycle methods to prevent memory leaks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>我们拿到数据库(storIOSQLite)读取(get)存有Tweet的列表(listOfObjects(Tweet.class))通过查询(Query)数据库表"tweets".我们需要得到Observable(asRxObservable())然后在主线程订阅(observeOn(mainThread())),最后将数据给adapter.并且后面每次tweets表发生变化都会触发这次刷新(除非取消订阅,当然为了不引发内存泄露,我们需要在合理的时候取消订阅).</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storiosqlite做了什么"><code>StorIOSQLite</code>做了什么?<a href="https://dannyjiajia.github.io/2017/think-about-storio#storiosqlite%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88" class="hash-link" aria-label="storiosqlite做了什么的直接链接" title="storiosqlite做了什么的直接链接">​</a></h3>
<ol>
<li>首先通过<code>Query</code>来获取需要查询的表,我们这里是<code>tweets</code></li>
<li>通过内部的<code>RxChangesBus</code>订阅变化(<code>Changes</code>),并通过<code>filter</code>操作符过滤出存在<code>tweets</code>表的变化</li>
<li>查询一次<code>Query</code>并通过<code>startWith</code>操作符插入查询结果(会通过listOfObjects进行实体转换)</li>
</ol>
<p>注意:一定要及时取消订阅,以免引起内存泄露</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="多张表的监听">多张表的监听<a href="https://dannyjiajia.github.io/2017/think-about-storio#%E5%A4%9A%E5%BC%A0%E8%A1%A8%E7%9A%84%E7%9B%91%E5%90%AC" class="hash-link" aria-label="多张表的监听的直接链接" title="多张表的监听的直接链接">​</a></h3>
<p>比如有这样的业务需求,我需要查询多张表以完成这次查询,但是一条SQL语句又不能实现.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">fetchDatasThenRefreshUI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#6B6B6B;font-style:italic">//读取数据并刷新UI,这里会读取table1和table2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mStorIOSQLite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">observeChangesInTables</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">Sets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newHashSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"table1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"table2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">changes </span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token function" style="color:#8250DF">fetchDatasThenRefreshUI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//如果有变化再次读取数据库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>上面的写法是不是很繁琐,我们重构一下...</p>
</blockquote>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mStorIOSQLite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">observeChangesInTables</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">Sets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newHashSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"table1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"table2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">startWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">Changes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">compose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">Changes</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token function" style="color:#8250DF">bindUntilEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">FragmentEvent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#005CC5">DESTROY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//使用RxLifecycle自动取消订阅</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">subscribe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">changes </span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token function" style="color:#8250DF">fetchDatasThenRefreshUI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//读取数据并刷新UI,这里会读取table1和table2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主动通知变化">主动通知变化<a href="https://dannyjiajia.github.io/2017/think-about-storio#%E4%B8%BB%E5%8A%A8%E9%80%9A%E7%9F%A5%E5%8F%98%E5%8C%96" class="hash-link" aria-label="主动通知变化的直接链接" title="主动通知变化的直接链接">​</a></h3>
<p><code>StorIOSQLite</code>默认的通知变化是只要对一张表有数据操作时(CURD)均会发生通知,如果我们有个业务需求是需要给一个表里面插入1000条数据,插入成功后再刷新界面。
这个时候我们就需要<code>LowLevel</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name" style="color:#116329">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name" style="color:#116329">String</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> strings </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//存放了操作两个数据库表的sql语句</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">lowLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">beginTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//事务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">String</span><span class="token plain"> sql </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">lowLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">executeSQL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">RawQuery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sql</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">lowLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">setTransactionSuccessful</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//通知table1和table2发生了变化(触发再次读取事件)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">lowLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">notifyAboutChanges</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">Changes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">Sets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newHashSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"table1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"table2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">finally</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mStorIOSQLite</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">lowLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">endTransaction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Android</category>
            <category>RxJava</category>
        </item>
        <item>
            <title><![CDATA[2017开篇:curl使用备忘]]></title>
            <link>https://dannyjiajia.github.io/2017/login-with-curl</link>
            <guid>https://dannyjiajia.github.io/2017/login-with-curl</guid>
            <pubDate>Mon, 13 Feb 2017 12:33:55 GMT</pubDate>
            <description><![CDATA[真的好久没写东西了,主要原因是去年下半年太忙了,忙着找工作忙着边学边做Android...]]></description>
            <content:encoded><![CDATA[<p>真的好久没写东西了,主要原因是去年下半年太忙了,忙着找工作忙着边学边做<code>Android</code>...
这里备注一下curl的使用,因为项目原因发布新版本的时候需要将编译后的<code>APK</code>文件上传到统一的版本管理后台.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="解析远端json文件并下载资源">解析远端Json文件并下载资源<a href="https://dannyjiajia.github.io/2017/login-with-curl#%E8%A7%A3%E6%9E%90%E8%BF%9C%E7%AB%AFjson%E6%96%87%E4%BB%B6%E5%B9%B6%E4%B8%8B%E8%BD%BD%E8%B5%84%E6%BA%90" class="hash-link" aria-label="解析远端Json文件并下载资源的直接链接" title="解析远端Json文件并下载资源的直接链接">​</a></h3>
<p>比如我这里需要解析<a href="http://gank.io/" target="_blank" rel="noopener noreferrer">干货集中营</a>的接口并下载图片</p>
<p>API:<a href="http://gank.io/api/data/%E7%A6%8F%E5%88%A9/10/1" target="_blank" rel="noopener noreferrer">http://gank.io/api/data/福利/10/1</a></p>
<p>解析Json我们使用<a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener noreferrer">jq</a>,可以用<code>Homebrew</code>安装</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">brew </span><span class="token function" style="color:#8250DF">install</span><span class="token plain"> jq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-s</span><span class="token plain"> http://gank.io/api/data/%E7%A6%8F%E5%88%A9/10/1 </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> jq </span><span class="token string" style="color:#C6105F">'.results[] | .url '</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">xargs</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-n</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-O</span><span class="token plain"> -</span><span class="token comment" style="color:#6B6B6B;font-style:italic">#</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="上传文件时显示进度">上传文件时显示进度<a href="https://dannyjiajia.github.io/2017/login-with-curl#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E6%97%B6%E6%98%BE%E7%A4%BA%E8%BF%9B%E5%BA%A6" class="hash-link" aria-label="上传文件时显示进度的直接链接" title="上传文件时显示进度的直接链接">​</a></h3>
<p>上传文件时如果需要显示进度必须显示指明<code>-o参数</code>比如<code>-o /dev/null</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="获取网络状态码">获取网络状态码<a href="https://dannyjiajia.github.io/2017/login-with-curl#%E8%8E%B7%E5%8F%96%E7%BD%91%E7%BB%9C%E7%8A%B6%E6%80%81%E7%A0%81" class="hash-link" aria-label="获取网络状态码的直接链接" title="获取网络状态码的直接链接">​</a></h3>
<p>使用<code>-w</code>参数</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-s</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-o</span><span class="token plain"> /dev/null </span><span class="token parameter variable" style="color:#E36209">-w</span><span class="token plain"> %</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">http_code</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> www.baidu.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>curl</category>
        </item>
        <item>
            <title><![CDATA[不同平台下的项目自动打包方式]]></title>
            <link>https://dannyjiajia.github.io/2016/autopackage</link>
            <guid>https://dannyjiajia.github.io/2016/autopackage</guid>
            <pubDate>Tue, 16 Aug 2016 11:21:49 GMT</pubDate>
            <description><![CDATA[iOS]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ios">iOS<a href="https://dannyjiajia.github.io/2016/autopackage#ios" class="hash-link" aria-label="iOS的直接链接" title="iOS的直接链接">​</a></h2>
<p>iOS下的打包主要由<code>xcodebuild</code>来完成.在xcode 7以前我通过<code>xcodebuild</code>构建项目然后通过<code>xcrun</code>来生成ipa文件.
类似以下命令</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xcodebuild </span><span class="token parameter variable" style="color:#E36209">-configuration</span><span class="token plain"> </span><span class="token variable" style="color:#E36209">${BuildConfig}</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-target</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${TargetName}</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">GCC_PREPROCESSOR_DEFINITIONS</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"\</span><span class="token string variable" style="color:#E36209">${GCC_PREPROCESSOR_DEFINITIONS}</span><span class="token string" style="color:#C6105F"> FREEVERSION=0"</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">WARNING_LDFLAGS</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"\</span><span class="token string variable" style="color:#E36209">${WARNING_LDFLAGS}</span><span class="token string" style="color:#C6105F"> -w"</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">CODE_SIGN_IDENTITY</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${DistributionCodeIdentity}</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">PROVISIONING_PROFILE</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${DistributionProvision}</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xcrun </span><span class="token parameter variable" style="color:#E36209">-sdk</span><span class="token plain"> iphoneos PackageApplication </span><span class="token parameter variable" style="color:#E36209">-v</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${ProductDir}</span><span class="token string" style="color:#C6105F">/</span><span class="token string variable" style="color:#E36209">${TargetName}</span><span class="token string" style="color:#C6105F">.app"</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-o</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${PrjDir}</span><span class="token string" style="color:#C6105F">/</span><span class="token string variable" style="color:#E36209">${IpaName}</span><span class="token string" style="color:#C6105F">"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这种方式打包有很多局限:</p>
<ol>
<li>需要自己备份生成的符号文件等.</li>
<li>在xcode 7以后这种打包方式不能通过苹果的审核.</li>
<li>如果需要其他证书的ipa的文件,又需要重新构建.</li>
</ol>
<p><strong>所以最好的方式是完全模拟xcode的发布包流程:先archive备份,然后通过压缩包导出不同证书的ipa</strong></p>
<p>如何实现呢? 只需要使用一个命令工具:<code>xcodebuild</code>.
这里就只说明xcode 7以后的命令使用方式.
首先我们<code>archive</code>项目:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xcodebuild </span><span class="token parameter variable" style="color:#E36209">-sdk</span><span class="token plain"> iphoneos </span><span class="token parameter variable" style="color:#E36209">-configuration</span><span class="token plain"> Release </span><span class="token parameter variable" style="color:#E36209">-scheme</span><span class="token plain"> </span><span class="token variable" style="color:#E36209">${SchemeName}</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-target</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${TargetName}</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-archivePath</span><span class="token plain"> </span><span class="token variable" style="color:#E36209">${ArchiveFileFullPath}</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">GCC_PREPROCESSOR_DEFINITIONS</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"\</span><span class="token string variable" style="color:#E36209">${GCC_PREPROCESSOR_DEFINITIONS}</span><span class="token string" style="color:#C6105F"> FREEVERSION=0"</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">WARNING_LDFLAGS</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"\</span><span class="token string variable" style="color:#E36209">${WARNING_LDFLAGS}</span><span class="token string" style="color:#C6105F"> -w"</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">CODE_SIGN_IDENTITY</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${DistributionCodeIdentity}</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">PROVISIONING_PROFILE</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"</span><span class="token string variable" style="color:#E36209">${DistributionProvision}</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> archive</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>SchemeName</code>为xcode中项目的<code>Scheme</code></li>
<li><code>TargetName</code>为项目的某个target名称</li>
<li><code>ArchiveFileFullPath</code>指定<code>xcarchive</code>文件的路径,如<code>HelloWorld.xcarchive</code></li>
<li><code>DistributionCodeIdentity</code>为证书的标示,值形如<code>iPhone Distribution: xxxx (xxx)</code></li>
<li><code>DistributionProvision</code>为profile的identifier,值形如<code>xxxx-xxxx-xxx-xxx-xx</code>(其实就是导入xcode后此profile的文件名)</li>
<li><code>GCC_PREPROCESSOR_DEFINITIONS</code>和<code>WARNING_LDFLAGS</code>都是xcode的环境变量</li>
</ul>
<p>生成成功<code>xcarchive</code>文件后我们就可以导出ipa文件了</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xcodebuild </span><span class="token parameter variable" style="color:#E36209">-exportArchive</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-exportOptionsPlist</span><span class="token plain"> </span><span class="token variable" style="color:#E36209">${ExportOptionsPlistPath}</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-archivePath</span><span class="token plain"> </span><span class="token variable" style="color:#E36209">${ArchiveFileFullPath}</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-exportPath</span><span class="token plain"> </span><span class="token variable" style="color:#E36209">${IpaFileDirectory}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>ExportOptionsPlistPath</code> 指向一个plist文件的路径,这个plist为这次导出提供参数，这里提供的信息其实就是你在xcode中导出ipa的时候选择的那些选项.</li>
<li><code>ArchiveFileFullPath</code> 是前面我们生成的<code>xcarchive</code> 文件路径</li>
<li><code>IpaFileDirectory</code> 是最终导出的ipa的目录(<em>注意这里是目录而不是具体的ipa文件路径</em>)</li>
</ul>
<p><code>ExportOptionsPlistPath</code>plist文件的格式类似如下:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token prolog" style="color:#999988;font-style:italic">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:#999988;font-style:italic">DOCTYPE</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">plist</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype name" style="color:#999988;font-style:italic">PUBLIC</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype string" style="color:#C6105F;font-style:italic">"-//Apple//DTD PLIST 1.0//EN"</span><span class="token doctype" style="color:#999988;font-style:italic"> </span><span class="token doctype string" style="color:#C6105F;font-style:italic">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span><span class="token doctype punctuation" style="color:#393A34;font-style:italic">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">plist</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">version</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">1.0</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">dict</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">method</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">app-store</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">teamID</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">key</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">开发证书的团队ID</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">string</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">dict</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">plist</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当然还有其他参数的控制比如bitcode 符号文件是否打包一起等等.具体里面可以有的参数及取值可以通过<code>xcodebuild -h</code>命令查看.
<code>method</code>我一般就用到<code>app-store</code>、<code>ad-hoc</code>、<code>development</code>这三个值,通过设置<code>teamID</code>后<code>xcodebuild</code>会自动查找对应的证书(前提是你必选在keychain中安装好这些证书)
我们可以在脚本中通过<code>PlistBuddy</code>动态修改这个plist文件的值来实现不同的打包的需求(当然也可以使用几个不同的plist)</p>
<p>最后我们就得到了xcarchive文件,然后根据不同的需求导出不同证书的ipa文件</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="android">Android<a href="https://dannyjiajia.github.io/2016/autopackage#android" class="hash-link" aria-label="Android的直接链接" title="Android的直接链接">​</a></h2>
<p>android上的打包就更复杂些.首先,如果有jni则需要先编译so文件并备份符号文件.然后是java的混淆日志文件等等.
不过android上则按着平时打包的步骤写成脚本就好<code>ant</code>或者<code>gradle</code>任务.
我推荐使用<code>gradle</code>插件进行开发,一是和<code>Android Studio</code>结合很强大,二是<code>gradle</code>可以直接调用<code>ant</code>任务:)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="windows-phone">Windows Phone<a href="https://dannyjiajia.github.io/2016/autopackage#windows-phone" class="hash-link" aria-label="Windows Phone的直接链接" title="Windows Phone的直接链接">​</a></h2>
<p>在<code>VS</code>里构建用的命令是<code>msbuild</code>(Microsoft Build Engine),它和<code>ant</code>的形式有些类似.是基于<code>xml</code>的配置，
其实<code>VS</code>中我们的设置最终落实到的依然是<code>Microsoft Build Engine</code>.这个xml文件就是<code>*.*proj</code>文件.
只是这里需要注意<code>Windows</code>下标准命令行的上下文是没有<code>msbuild</code>命令的.
我们需要运行类似名为<code>Visual Studio 2012 xxxx命令提示</code>的工具,但是我们可以手动将这个环境变量加入我们的<code>DOS</code>里.
比如下面的脚本先设置上下文,然后执行<code>msbuild</code>命令</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@echo off</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo./*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo. * Check VC++ environment</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name" style="color:#116329">set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">FOUND_VC</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name" style="color:#116329">set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">FOUND_OUTDIR</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> not </span><span class="token string" style="color:#C6105F">"%~1"</span><span class="token operator" style="color:#D73A49">==</span><span class="token string" style="color:#C6105F">""</span><span class="token plain"> </span><span class="token builtin class-name" style="color:#116329">set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">FOUND_OUTDIR</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> defined VS120COMNTOOLS </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name" style="color:#116329">set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">VSTOOLS</span><span class="token operator" style="color:#D73A49">=</span><span class="token string" style="color:#C6105F">"%VS120COMNTOOLS%"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name" style="color:#116329">set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">VC_VER</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">120</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin class-name" style="color:#116329">set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">FOUND_VC</span><span class="token operator" style="color:#D73A49">=</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name" style="color:#116329">set</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#E36209">VSTOOLS</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">%VSTOOLS:</span><span class="token string" style="color:#C6105F">"=%</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">set "</span><span class="token plain">VSTOOLS</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">%VSTOOLS:</span><span class="token punctuation" style="color:#393A34">\</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">/%</span><span class="token string" style="color:#C6105F">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">set VSVARS="</span><span class="token plain">%VSTOOLS%vsvars32.bat</span><span class="token string" style="color:#C6105F">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">if not defined VSVARS (</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">    echo Can't find VC2013 installed!</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">    goto ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">echo./*</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">echo. * Building Windows Phone Project...</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">echo. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">echo.</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">call %VSVARS%</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">if %FOUND_VC%==1 (</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#C6105F">	msbuild  HelloWorld.WindowsPhone.vcxproj /p:Configuration="</span><span class="token plain">Release</span><span class="token string" style="color:#C6105F">"  /p:Platform="</span><span class="token plain">ARM" /t:Clean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">Rebuild</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>msbuild  HelloWorld.WindowsPhone.vcxproj /p:Configuration="Release"  /p:Platform="ARM" /t:Clean;Rebuild</code>表示在<code>Release</code>模式下清理然后重新构建<code>HelloWorld.WindowsPhone.vcxproj</code>项目,目标平台为<code>ARM</code>.
命令会按以前构建的目标目录导出最终的包文件,如果之前没设置,则在当前目录.如果需要指定通过参数<code>/p:OutDir=路径</code>设置</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="验证安装包">验证安装包<a href="https://dannyjiajia.github.io/2016/autopackage#%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85%E5%8C%85" class="hash-link" aria-label="验证安装包的直接链接" title="验证安装包的直接链接">​</a></h3>
<p>微软提供了一个命令行工具<code>appcert.exe</code>来验证,这个文件的一般路径为:<code>C:\Program Files (x86)\Windows Kits\10\App Certification Kit\appcert.exe</code></p>
<blockquote>
<p>appcert.exe test -appxpackagepath 包路径 -reportoutputpath 生成xml格式的报告文件路径</p>
</blockquote>
<p><strong>注意:这里说明的是基于<code>VS2013</code>的开发环境.<code>VS2015</code>可能有些出入.</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="部署安装包到设备">部署安装包到设备<a href="https://dannyjiajia.github.io/2016/autopackage#%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85%E5%8C%85%E5%88%B0%E8%AE%BE%E5%A4%87" class="hash-link" aria-label="部署安装包到设备的直接链接" title="部署安装包到设备的直接链接">​</a></h3>
<p><code>AppDeployCmd.exe</code>
一般路径为:<code>C:\Program Files (x86)\Microsoft SDKs\Windows Phone\v8.1\Tools\AppDeploy\AppDeployCmd.exe</code></p>
<blockquote>
<p>AppDeployCmd.exe /install 包路径 /targetdevice<!-- -->:de</p>
</blockquote>
<p>End:)</p>]]></content:encoded>
            <category>iOS</category>
            <category>Android</category>
            <category>Windows Phone</category>
        </item>
        <item>
            <title><![CDATA[说说Core Graphics]]></title>
            <link>https://dannyjiajia.github.io/2016/thinking-core-graphics</link>
            <guid>https://dannyjiajia.github.io/2016/thinking-core-graphics</guid>
            <pubDate>Wed, 03 Aug 2016 11:18:01 GMT</pubDate>
            <description><![CDATA[记得11年左右做iOS开发的人真不多,大环境下大家学习iOS开发基本都靠WWDC和国外的文献,近几年随着iOS开发的火爆,好多技术都被挖掘出来(其实是自己以前英文不好,好多东西都是点到为止),最近比较闲重新看了下iOS相关的一些东西.感觉有些东西虽然不是常用的,但明白后可以更灵活的运用到日常的开发中.这里记录下我对iOS里一些特性理解.]]></description>
            <content:encoded><![CDATA[<p>记得11年左右做iOS开发的人真不多,大环境下大家学习iOS开发基本都靠WWDC和国外的文献,近几年随着iOS开发的火爆,好多技术都被挖掘出来(其实是自己以前英文不好,好多东西都是点到为止),最近比较闲重新看了下iOS相关的一些东西.感觉有些东西虽然不是常用的,但明白后可以更灵活的运用到日常的开发中.这里记录下我对iOS里一些特性理解.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="广义的离屏渲染">广义的离屏渲染?<a href="https://dannyjiajia.github.io/2016/thinking-core-graphics#%E5%B9%BF%E4%B9%89%E7%9A%84%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93" class="hash-link" aria-label="广义的离屏渲染?的直接链接" title="广义的离屏渲染?的直接链接">​</a></h2>
<p>首先看GPU屏幕渲染两种方式:</p>
<ul>
<li>On-Screen Rendering:意为当前屏幕渲染，指的是GPU的渲染操作是在当前用于显示的屏幕缓冲区中进行。</li>
<li>Off-Screen Rendering:意为离屏渲染，指的是GPU在当前屏幕缓冲区以外新开辟一个缓冲区进行渲染操作。</li>
</ul>
<p>上面的两种方式都是在GPU中执行的,离屏渲染会开辟一个缓冲区上下文进行渲染(这里不会在屏幕上显示),然后进行上下的切换.比如将之前开辟的缓冲区设置为当前屏幕的缓冲区(显示到屏幕),但这里开销比较大。
而<code>Core Graphics</code>是<code>Software rendering</code>,也就是<code>CPU</code>执行<code>GPU</code>上一样的算法(<code>GPU</code>能更好的执行并发任务).
参考:<a href="https://en.wikipedia.org/wiki/Software_rendering" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Software_rendering</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="离屏渲染并不意味着软件绘制">离屏渲染并不意味着软件绘制?<a href="https://dannyjiajia.github.io/2016/thinking-core-graphics#%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93%E5%B9%B6%E4%B8%8D%E6%84%8F%E5%91%B3%E7%9D%80%E8%BD%AF%E4%BB%B6%E7%BB%98%E5%88%B6" class="hash-link" aria-label="离屏渲染并不意味着软件绘制?的直接链接" title="离屏渲染并不意味着软件绘制?的直接链接">​</a></h2>
<p><code>QuartzCore Framework</code>通过<code>Core Anmation</code>来把我们构建的界面绘制到屏幕上(通过操作openGL ES).
这里面会使用<code>openGL ES</code>的缓冲区,它是在<code>GPU</code>里执行的。比如<code>CALayer</code>的<code>masking</code>就使用了片段着色器.
<img decoding="async" loading="lazy" src="http://cc.cocimg.com/api/uploads/20150428/1430209790572112.png" alt="CoreAnmation" class="img_ev3q"></p>
<blockquote>
<p>这里说明下CALayer的mask,它是根据设置的layer的alpha值进行过滤像素实现模板的(片段着色器),不是openGL ES中的模板测试实现的</p>
</blockquote>
<p>参考WWDC:<a href="https://developer.apple.com/videos/play/wwdc2014/419/" target="_blank" rel="noopener noreferrer">https://developer.apple.com/videos/play/wwdc2014/419/</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quartz-2d-和quartz-core的区别是什么">Quartz 2D 和Quartz Core的区别是什么?<a href="https://dannyjiajia.github.io/2016/thinking-core-graphics#quartz-2d-%E5%92%8Cquartz-core%E7%9A%84%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Quartz 2D 和Quartz Core的区别是什么?的直接链接" title="Quartz 2D 和Quartz Core的区别是什么?的直接链接">​</a></h2>
<p><code>QuartzCore Framework</code>通过<code>Core Anmation</code>来把我们构建的界面绘制到屏幕上.
<code>Quartz 2D</code>是<code>CoreGraphics Framework</code>下一套API</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-graphics有颜色的混合设置吗">Core Graphics有颜色的混合设置吗?<a href="https://dannyjiajia.github.io/2016/thinking-core-graphics#core-graphics%E6%9C%89%E9%A2%9C%E8%89%B2%E7%9A%84%E6%B7%B7%E5%90%88%E8%AE%BE%E7%BD%AE%E5%90%97" class="hash-link" aria-label="Core Graphics有颜色的混合设置吗?的直接链接" title="Core Graphics有颜色的混合设置吗?的直接链接">​</a></h2>
<p><code>CGBlendMode</code>定义了很多预设模式,可以通过<code>drawInRect:blendMode:alpha:</code>或者<code>UIRectFillUsingBlendMode(...)</code>等函数进行混合模式的设置。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="opengl-es的数据可以用core-graphics绘制吗">openGL ES的数据可以用Core Graphics绘制吗?<a href="https://dannyjiajia.github.io/2016/thinking-core-graphics#opengl-es%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%AF%E4%BB%A5%E7%94%A8core-graphics%E7%BB%98%E5%88%B6%E5%90%97" class="hash-link" aria-label="openGL ES的数据可以用Core Graphics绘制吗?的直接链接" title="openGL ES的数据可以用Core Graphics绘制吗?的直接链接">​</a></h2>
<p>具体的转换方法参考这里:<a href="http://gamesfromwithin.com/remixing-opengl-and-uikit" target="_blank" rel="noopener noreferrer">http://gamesfromwithin.com/remixing-opengl-and-uikit</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何理解贝塞尔曲线">如何理解贝塞尔曲线<a href="https://dannyjiajia.github.io/2016/thinking-core-graphics#%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF" class="hash-link" aria-label="如何理解贝塞尔曲线的直接链接" title="如何理解贝塞尔曲线的直接链接">​</a></h2>
<p>通过维基百科的图理解:)</p>
<ul>
<li>二次贝塞尔曲线只有一个控制点p1
<img decoding="async" loading="lazy" src="http://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/Bezier_2_big.gif/240px-Bezier_2_big.gif" alt="二次贝塞尔曲线" class="img_ev3q"></li>
<li>三次贝塞尔曲线有两个控制点p1和p2
<img decoding="async" loading="lazy" src="http://upload.wikimedia.org/wikipedia/commons/thumb/f/ff/Bezier_3_big.gif/240px-Bezier_3_big.gif" alt="三次贝塞尔曲线" class="img_ev3q"></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考">参考<a href="https://dannyjiajia.github.io/2016/thinking-core-graphics#%E5%8F%82%E8%80%83" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接">​</a></h2>
<ul>
<li><a href="https://github.com/gnustep/quartzcore" target="_blank" rel="noopener noreferrer">https://github.com/gnustep/quartzcore</a></li>
<li><a href="http://www.jianshu.com/p/6d24a4c29e18" target="_blank" rel="noopener noreferrer">http://www.jianshu.com/p/6d24a4c29e18</a></li>
<li><a href="http://www.jianshu.com/p/0e785269dccc" target="_blank" rel="noopener noreferrer">http://www.jianshu.com/p/0e785269dccc</a></li>
</ul>]]></content:encoded>
            <category>iOS</category>
        </item>
        <item>
            <title><![CDATA[以ABS宏为例说说Clang中的宏定义方式技巧]]></title>
            <link>https://dannyjiajia.github.io/2016/thinking-about-macro</link>
            <guid>https://dannyjiajia.github.io/2016/thinking-about-macro</guid>
            <pubDate>Mon, 25 Jul 2016 17:25:56 GMT</pubDate>
            <description><![CDATA[我们在iOS开发的时候经常使用宏定义,最常用的宏肯定是DEBUG,像下面这样:)]]></description>
            <content:encoded><![CDATA[<p>我们在iOS开发的时候经常使用宏定义,最常用的宏肯定是<code>DEBUG</code>,像下面这样:)</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">DEBUG</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression function" style="color:#8250DF">__has_feature</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">objc_arc_weak</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">elif</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression function" style="color:#8250DF">__has_feature</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">objc_arc</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">TARGET_OS_MAC </span><span class="token macro property expression operator" style="color:#D73A49">||</span><span class="token macro property expression" style="color:#005CC5"> TARGET_OS_IPHONE</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>记录下我对Clang中定义的宏<code>ABS</code>的理解(从零开始的理解),它的作用很简单:<code>得到一个数的绝对值</code>。</p>
<p>宏分为对象宏(object-like macro)和函数宏(function-like macro)。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="对象宏">对象宏<a href="https://dannyjiajia.github.io/2016/thinking-about-macro#%E5%AF%B9%E8%B1%A1%E5%AE%8F" class="hash-link" aria-label="对象宏的直接链接" title="对象宏的直接链接">​</a></h2>
<p>对象宏就是我们定义的一些固定值,就像苹果的定义:</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">/*  Even though these might be more useful as long doubles, POSIX requires</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">    that they be double-precision literals.                                   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_E</span><span class="token macro property" style="color:#005CC5">         </span><span class="token macro property expression number" style="color:#005CC5">2.71828182845904523536028747135266250</span><span class="token macro property expression" style="color:#005CC5">   </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* e              */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_LOG2E</span><span class="token macro property" style="color:#005CC5">     </span><span class="token macro property expression number" style="color:#005CC5">1.44269504088896340735992468100189214</span><span class="token macro property expression" style="color:#005CC5">   </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* log2(e)        */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_LOG10E</span><span class="token macro property" style="color:#005CC5">    </span><span class="token macro property expression number" style="color:#005CC5">0.434294481903251827651128918916605082</span><span class="token macro property expression" style="color:#005CC5">  </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* log10(e)       */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_LN2</span><span class="token macro property" style="color:#005CC5">       </span><span class="token macro property expression number" style="color:#005CC5">0.693147180559945309417232121458176568</span><span class="token macro property expression" style="color:#005CC5">  </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* loge(2)        */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_LN10</span><span class="token macro property" style="color:#005CC5">      </span><span class="token macro property expression number" style="color:#005CC5">2.30258509299404568401799145468436421</span><span class="token macro property expression" style="color:#005CC5">   </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* loge(10)       */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_PI</span><span class="token macro property" style="color:#005CC5">        </span><span class="token macro property expression number" style="color:#005CC5">3.14159265358979323846264338327950288</span><span class="token macro property expression" style="color:#005CC5">   </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* pi             */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_PI_2</span><span class="token macro property" style="color:#005CC5">      </span><span class="token macro property expression number" style="color:#005CC5">1.57079632679489661923132169163975144</span><span class="token macro property expression" style="color:#005CC5">   </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* pi/2           */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_PI_4</span><span class="token macro property" style="color:#005CC5">      </span><span class="token macro property expression number" style="color:#005CC5">0.785398163397448309615660845819875721</span><span class="token macro property expression" style="color:#005CC5">  </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* pi/4           */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_1_PI</span><span class="token macro property" style="color:#005CC5">      </span><span class="token macro property expression number" style="color:#005CC5">0.318309886183790671537767526745028724</span><span class="token macro property expression" style="color:#005CC5">  </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* 1/pi           */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_2_PI</span><span class="token macro property" style="color:#005CC5">      </span><span class="token macro property expression number" style="color:#005CC5">0.636619772367581343075535053490057448</span><span class="token macro property expression" style="color:#005CC5">  </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* 2/pi           */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_2_SQRTPI</span><span class="token macro property" style="color:#005CC5">  </span><span class="token macro property expression number" style="color:#005CC5">1.12837916709551257389615890312154517</span><span class="token macro property expression" style="color:#005CC5">   </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* 2/sqrt(pi)     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_SQRT2</span><span class="token macro property" style="color:#005CC5">     </span><span class="token macro property expression number" style="color:#005CC5">1.41421356237309504880168872420969808</span><span class="token macro property expression" style="color:#005CC5">   </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* sqrt(2)        */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name" style="color:#005CC5">M_SQRT1_2</span><span class="token macro property" style="color:#005CC5">   </span><span class="token macro property expression number" style="color:#005CC5">0.707106781186547524400844362104849039</span><span class="token macro property expression" style="color:#005CC5">  </span><span class="token macro property comment" style="color:#6B6B6B;font-style:italic">/* 1/sqrt(2)      */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>理解成简单的替换代码就好。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="函数宏">函数宏<a href="https://dannyjiajia.github.io/2016/thinking-about-macro#%E5%87%BD%E6%95%B0%E5%AE%8F" class="hash-link" aria-label="函数宏的直接链接" title="函数宏的直接链接">​</a></h2>
<p>函数宏就像函数一样接受参数,就像上文中说到的<code>ABS</code>宏</p>
<h1>定义ABS宏</h1>
<p>我们尝试自己定义一个宏<code>ABS</code>,功能和<code>Clang</code>的一样,得到一个数的绝对值。</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">//version 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">ABS</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> A </span><span class="token macro property expression operator" style="color:#D73A49">&lt;</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression number" style="color:#005CC5">0</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">?</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">-</span><span class="token macro property expression" style="color:#005CC5"> A </span><span class="token macro property expression punctuation" style="color:#393A34">:</span><span class="token macro property expression" style="color:#005CC5"> A</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后使用</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token function" style="color:#8250DF">ABS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>好简单,完成了。别人拿去一用马上出问题了,只能说还是太年轻了:)</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token function" style="color:#8250DF">ABS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//1 error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//NSLog(@"%d",-1 &lt; 0 ? 1 : 1 + 1)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>把上面的宏展开就明显看出结果是<code>1</code>,我们应该把表达式的结果作为结果替换宏,
so我们修复我们的宏:</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">//version 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">ABS</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A </span><span class="token macro property expression operator" style="color:#D73A49">&lt;</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression number" style="color:#005CC5">0</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">?</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">-</span><span class="token macro property expression" style="color:#005CC5"> A </span><span class="token macro property expression punctuation" style="color:#393A34">:</span><span class="token macro property expression" style="color:#005CC5"> A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以为天下太平了? <code>No</code>,如果像下面这样用呢?</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token function" style="color:#8250DF">ABS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">2</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">3</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//-1 error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//NSLog(@"%d",2 &lt; 3 ? -1 : -2 &lt; 0 ? - 2 &lt; 3 ? -1 : -2 : 2 &lt; 3 ? -1 : -2);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//NSLog(@"%d",(2 &lt; 3 ? -1 : -2 ) &lt; 0 ? (- 2 &lt; 3 ? -1 : -2) : (2 &lt; 3 ? -1 : -2));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>哈哈，是不是被运算符优先级吓到了? 其实我们需要保证我们参数可以是表达式。</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">//version 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">ABS</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">&lt;</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression number" style="color:#005CC5">0</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">?</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">-</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">:</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在这个宏基本胜任了大部分地方,但是过几天某大牛突然过来找你,说你提供的宏有问题!</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> a </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token function" style="color:#8250DF">ABS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token operator" style="color:#D73A49">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//0 error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#6B6B6B;font-style:italic">//1 error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你看到这代码的第一反应可能是,卧槽,为什么一定要用<code>a++</code>就不能用完了再<code>+1</code>嘛！可是大牛说他就爱这样写,代码简洁...
好！我们还是老实的展开这个宏</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token operator" style="color:#D73A49">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token operator" style="color:#D73A49">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token operator" style="color:#D73A49">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>a++</code>表示先使用<code>a</code>的值,然后对<code>a</code>进行自加1,上面的展开的宏中,第一次<code>a</code>和<code>0</code>比较过后进行了自加<code>1</code>变成了<code>0</code>,后面返回<code>0</code>后又自加<code>1</code>，所以<code>a</code>最后的值变成了<code>1</code>!
为了解决这个问题我们先算出表达式<code>A</code>的值,保证它只被计算一次。</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">//version 4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">ABS</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression function" style="color:#8250DF">__typeof__</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> __a </span><span class="token macro property expression operator" style="color:#D73A49">=</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#005CC5"> __a </span><span class="token macro property expression operator" style="color:#D73A49">&lt;</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression number" style="color:#005CC5">0</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">?</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">-</span><span class="token macro property expression" style="color:#005CC5"> __a </span><span class="token macro property expression punctuation" style="color:#393A34">:</span><span class="token macro property expression" style="color:#005CC5"> __a</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>({...})</code>是语句表达式,GNU C 把包含在括号中的复合语句看做是一个表达式，称为语句表达式，它可以出现在任何允许表达式的地方，你可以在语句表达式中使用循环、局部变量等，原本只能在复合语句中使用。</p>
<h1>苹果定义的ABS</h1>
<p>最后我们来看看苹果定义的<code>ABS</code>宏:</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">__NSX_PASTE__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#005CC5">B</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> A</span><span class="token macro property punctuation" style="color:#393A34">##</span><span class="token macro property expression" style="color:#005CC5">B</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">!</span><span class="token macro property expression function" style="color:#8250DF">defined</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">ABS</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">__NSABS_IMPL__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#005CC5">L</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression function" style="color:#8250DF">__typeof__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression function" style="color:#8250DF">__NSX_PASTE__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">__a</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#005CC5">L</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">=</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression function" style="color:#8250DF">__NSX_PASTE__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">__a</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#005CC5">L</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">&lt;</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression number" style="color:#005CC5">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">?</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">-</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression function" style="color:#8250DF">__NSX_PASTE__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">__a</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#005CC5">L</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">:</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression function" style="color:#8250DF">__NSX_PASTE__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">__a</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#005CC5">L</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">define</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property macro-name function" style="color:#8250DF">ABS</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression function" style="color:#8250DF">__NSABS_IMPL__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#005CC5">A</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#005CC5">__COUNTER__</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看起来和我们自己定义的<code>ABS</code>整体架构差不多,<code>__NSX_PASTE__</code>中的<code>##</code>是特殊符号用来连接两个参数。比如上面是<code>__a</code>和<code>L</code>，而<code>L</code>传入的是<code>__COUNTER__</code>，它是使用一次后便会自加1的特殊宏.也就是为了给我们的变量加了后缀。这是为了确保在这个作用域中宏不会出现相同变量。
像我们自己定义的宏一样简单的使用<code>__a</code>变量,如果代码的作用域中有重复的<code>__a</code>变量就悲剧了... 比如我们像下面这样使用我们先前自己定义的<code>ABS</code>宏(version 4)就会发现错误了...</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> __a </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token function" style="color:#8250DF">ABS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__a</span><span class="token operator" style="color:#D73A49">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//32767 error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">__a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// -1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>你看了上面苹果的定义后应该知道怎么修改我们的定义了吧
:) end</p>]]></content:encoded>
            <category>iOS</category>
        </item>
        <item>
            <title><![CDATA[用Lua实现A*寻路算法]]></title>
            <link>https://dannyjiajia.github.io/2016/findWay</link>
            <guid>https://dannyjiajia.github.io/2016/findWay</guid>
            <pubDate>Fri, 22 Jul 2016 19:37:17 GMT</pubDate>
            <description><![CDATA[关于A*寻路的算法参考这篇文章]]></description>
            <content:encoded><![CDATA[<p>关于A*寻路的算法参考这篇<a href="http://www.cnblogs.com/zhoug2020/p/3468167.html" target="_blank" rel="noopener noreferrer">文章</a></p>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">-------------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- 预定义工具类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-------------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- 定义类</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">class</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">classname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> super</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> superType </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">super</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> superType </span><span class="token operator" style="color:#D73A49">~=</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"function"</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> superType </span><span class="token operator" style="color:#D73A49">~=</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"table"</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        superType </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> superType </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"function"</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">super </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__ctype </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- inherited from native C++ Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> superType </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"table"</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- copy fields from super</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">v </span><span class="token keyword" style="color:#CF222E">in</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">pairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">super</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"> cls</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> v </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__create </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> super</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">super    </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> super</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__create </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> super</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctor </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__cname </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> classname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__ctype </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> instance </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">__create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- copy fields from class to native object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">v </span><span class="token keyword" style="color:#CF222E">in</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">pairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> v </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">class </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ctor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- inherited from Lua Object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> super </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#8250DF">setmetatable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">__index </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> super</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">super </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> super</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cls </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ctor </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__cname </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> classname</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__ctype </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">2</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- lua</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__index </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> cls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> instance </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">setmetatable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">class </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ctor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> cls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- 判断是否是类的实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> classname</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> t </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> mt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> t </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"table"</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mt </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">getmetatable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">while</span><span class="token plain"> mt </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> mt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__cname </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> classname </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mt </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> mt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">super</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-------------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- 逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-------------------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> ASSERT_FUNC </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"error:%s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">getinfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- Point</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> PathPoint </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">class</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ctor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getXY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">h </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parent </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">generalPointString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> infoString </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"PathPoint:[%s]@F|G|H:[%s %s %s]"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">tostring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain">  </span><span class="token string" style="color:#C6105F">"unkown"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">tostring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain">  </span><span class="token string" style="color:#C6105F">"unkown"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">tostring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain">  </span><span class="token string" style="color:#C6105F">"unkown"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        infoString </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"%s\nPathPoint:[%s]@Parent:%s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            infoString</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">generalPointString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> infoString</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"%d_%d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PathPoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__tostring </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">generalPointString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- Pathfinding 2D</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> Pathfinding </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">class</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"Pathfinding"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ctor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mapData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">reachableFunction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_openList </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_closedList </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setMapData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mapData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setReachableFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reachableFunction</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- private functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listAddPoint_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'table'</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listRemovePoint_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'table'</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"> list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">nil</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listGetMinFPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'table'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">ret </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">p </span><span class="token keyword" style="color:#CF222E">in</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">pairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ret </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'table'</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">ID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listIsEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'table'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- logic private methods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">canReach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isReachableByXY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isCloseListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PathPoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">false</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getSurroundPoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> ret </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> x </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">+</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> y </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">+</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">canReach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PathPoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">closeListAddPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listAddPoint_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_closedList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isCloseListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_closedList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">openListMinFPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listGetMinFPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_openList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">openListAddPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listAddPoint_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_openList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isOpenListIsEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listIsEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_openList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">openListRemovePoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listRemovePoint_</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_openList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isOpenListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_openList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getOpenListMinFPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">listGetMinFPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_openList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getMapItemDataByXY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_mapData </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_mapData</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#8250DF">tonumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_mapData</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#8250DF">tonumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#8250DF">tonumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_mapData</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#8250DF">tonumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#8250DF">tonumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isReachableByXY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_reachableFunc </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">true</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- if reachable function is not set,we want all postions are reachable.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> itemData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getMapItemDataByXY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> itemData </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">m_reachableFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">itemData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isPointReadchable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">iskindof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"PathPoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isReachableByXY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">calcG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> G </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> parentG </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">and</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">or</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> G </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> parentG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">calcH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> endP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> endP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">notFoundPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempStart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">endP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempStart</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">calcG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempStart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">calcH</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">openListAddPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">foundPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempStart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> G </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">calcG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempStart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> G </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempStart</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">G</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">generatePoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> ret </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> point </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">while</span><span class="token plain"> point </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            point </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- public api</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">------------------------------------------------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setReachableFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> func </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'function'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_reachableFunc </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> func</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">setMapData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mapData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> mapData </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">ASSERT_FUNC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mapData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'table'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m_mapData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> mapData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">findPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">startPoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">endPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">openListAddPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">startPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">while</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isOpenListIsEmpty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> tempPoint </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">openListMinFPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">openListRemovePoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">closeListAddPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isCloseListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> endPoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> surroundPoints </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getSurroundPoints</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> __</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">point </span><span class="token keyword" style="color:#CF222E">in</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">ipairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">surroundPoints</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isOpenListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">foundPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempPoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">notFoundPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tempPoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endPoint</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isOpenListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isOpenListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">isOpenListContainsPoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pathfinding</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PathPoint </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> PathPoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> Pathfinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>使用</h1>
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> Pathfinding </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"Pathfinding"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> PathPoint </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PathPoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">generalMapData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> map </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> map</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dumpMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"------------"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"-- Map Data"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"------------"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> iR</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">row </span><span class="token keyword" style="color:#CF222E">in</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">ipairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">~=</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'table'</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> iC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">column </span><span class="token keyword" style="color:#CF222E">in</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">ipairs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"%s "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token function" style="color:#8250DF">tostring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">column</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"\n"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"------------"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> data </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">generalMapData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">dumpMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> finder </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> Pathfinding</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#CF222E">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> val </span><span class="token operator" style="color:#D73A49">~=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">-- test find way from 3,2 to 3,5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> retPoint </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> finder</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">findPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PathPoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">PathPoint</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> retPoint </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">while</span><span class="token plain"> retPoint </span><span class="token keyword" style="color:#CF222E">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">retPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getX</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">retPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"*"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		retPoint </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> retPoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token function" style="color:#8250DF">getParent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">dumpMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Lua</category>
        </item>
        <item>
            <title><![CDATA[WindowsPhone的TextBox多行支持及疑问]]></title>
            <link>https://dannyjiajia.github.io/2016/multiline-textbox-wp8-1</link>
            <guid>https://dannyjiajia.github.io/2016/multiline-textbox-wp8-1</guid>
            <pubDate>Wed, 20 Jul 2016 14:57:34 GMT</pubDate>
            <description><![CDATA[最近在使用2dx的时候改造了一个UIEditBox,使其支持多行输入,因为在Windows Phone上单行和多行输入都是使用同一个系统控件TextBox,关于如何使用多行输入,可以参考微软的文档]]></description>
            <content:encoded><![CDATA[<p>最近在使用2dx的时候改造了一个<a href="https://github.com/cocos2d/cocos2d-x/blob/v3/cocos/ui/UIEditBox/UIEditBoxImpl-winrt.cpp" target="_blank" rel="noopener noreferrer">UIEditBox</a>,使其支持多行输入,因为在Windows Phone上单行和多行输入都是使用同一个系统控件<code>TextBox</code>,关于如何使用多行输入,可以参考微软的<a href="https://msdn.microsoft.com/en-us/library/ms742157.aspx" target="_blank" rel="noopener noreferrer">文档</a></p>
<p>当然Cocos2dx在3.5以上的版本中已经是使用cpp(cx)的开发模板,大意的代码如下:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">TextWrapping </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> Windows</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">UI</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Xaml</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TextWrapping</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Wrap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">AcceptsReturn </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们新加了一个类<code>UITextViewWinRT</code>提供系统的多行输入。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">UITextViewWinRT</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">SetupTextBox</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">RemoveTextBox</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> ref </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> TextBox</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">Name </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"cocos2d_editbox_textbox"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">MinWidth </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">200</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">PlaceholderText </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> m_strPlaceholder</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">Select</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">Text</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">Length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">MaxLength </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> m_maxLength </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> m_maxLength</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">MinHeight </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">MaxHeight </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">200</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">TextWrapping </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> Windows</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">UI</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Xaml</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">TextWrapping</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Wrap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">AcceptsReturn </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">SetInputScope</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m_textBox</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m_inputMode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m_textBox</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">Text </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> m_strText</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//注意这行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> g </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">findXamlElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m_flyout</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">Content</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"cocos2d_editbox_grid"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> grid </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">dynamic_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">Grid</span><span class="token generic-function generic class-name operator" style="color:#D73A49">^</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grid</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">Children</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">InsertAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m_textBox</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果阅读过官方的<code>UIEditBoxImpl-winrt.cpp</code>加上细心的同学会注意<code>m_textBox-&gt;Text = m_strText; //注意这行</code>这行代码,因为我将这段代码放到设置<code>TextBox</code>支持多行输出的代码后面了。</p>
<p><strong>如果不这样的的话,如果你给<code>TextBox</code>设置多行文本的时候是无效的</strong>,猜想可能是系统在设置其文本属性的时候计算了文本的摆放的结构,当渲染的时候进行渲染.
Windows Phone的换行符为<code>\r\n</code>不是一般的<code>\n</code>,这会引起新的问题,2dx里将<code>unicode</code>码转化成<code>UTF8</code>在<code>Label</code>里显示<code>\r</code>会被显示为乱码！</p>
<p>我的修改方案是</p>
<ul>
<li>
<p>Platform::String(unicode)转为std::string(UTF8)的时候移除<code>\r</code>,因为在2dx的<code>Label</code>里<code>\n</code>就是表示换行</p>
</li>
<li>
<p>std::string转为Platform::String的时候将<code>\n</code>替换为<code>\r\n</code>,让系统控件识别换行</p>
</li>
</ul>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">   </span><span class="token function" style="color:#8250DF">replace_all_distinct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">   str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain">   std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">   old_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">   new_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">size_type </span><span class="token function" style="color:#8250DF">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> pos </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">npos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> pos </span><span class="token operator" style="color:#D73A49">+=</span><span class="token plain"> new_value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">old_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">npos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> old_value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">length</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> new_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain">   </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain">   str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Platform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">String</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">UITextViewImplWinrt</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">stringToPlatformString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string strSrc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string newSrc </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">replace_all_distinct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strSrc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"\n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"\r\n"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#6B6B6B;font-style:italic">// to wide char</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> nStrLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">MultiByteToWideChar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CP_UTF8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newSrc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">c_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">wchar_t</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pWStr </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">wchar_t</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nStrLen </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pWStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nStrLen </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">MultiByteToWideChar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CP_UTF8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newSrc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">c_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pWStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nStrLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Platform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">String</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> strDst </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> ref </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Platform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pWStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">delete</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pWStr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> strDst</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string </span><span class="token class-name" style="color:#116329">UITextViewImplWinrt</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">PlatformStringTostring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Platform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">String</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> strSrc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">wchar_t</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pWStr </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> strSrc</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">Data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> nStrLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">WideCharToMultiByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CP_UTF8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pWStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pStr </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">nStrLen </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nStrLen </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">WideCharToMultiByte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CP_UTF8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pWStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nStrLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string strDst </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">delete</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pStr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string ret </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">replace_all_distinct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strDst</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"\r\n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"\n"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Cocos2dx</category>
            <category>Windows Phone</category>
        </item>
        <item>
            <title><![CDATA[Cocos2dx使用ETC1+Alpha压缩纹理]]></title>
            <link>https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx</link>
            <guid>https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx</guid>
            <pubDate>Fri, 15 Jul 2016 13:41:42 GMT</pubDate>
            <description><![CDATA[我们为了优化游戏的内存占用,会给图片资源进行有损压缩,在Android上则是使用ETC1(Ericsson texture compression)进行纹理压缩,压缩纹理无论从加载速度(GPU识别)和内存占用都有很大的优势,唯一的缺点就是有损。]]></description>
            <content:encoded><![CDATA[<p>我们为了优化游戏的内存占用,会给图片资源进行<code>有损压缩</code>,在Android上则是使用<code>ETC1</code>(Ericsson texture compression)进行纹理压缩,压缩纹理无论从加载速度(GPU识别)和内存占用都有很大的优势,唯一的缺点就是有损。
也就是它不是<code>万金油</code>,并不是所有的图片都能使用<code>ETC1</code>压缩。我在记录下我是如何在<code>Cocos2dx</code>中使用<code>ETC1</code>进行纹理压缩.当然这里是在<code>android</code>平台下使用。</p>
<p>ETC1格式是OpenGL ES图形标准的一部分，并且被所有的Android设备所支持,不支持透明通道。需要是POT纹理。虽然后面的<code>ETC2</code>支持透明通道,但是它是<code>OpenGL 3.0</code>的标准，并不能被所有Android设备所支持，而<code>ETC1</code>我们能通过技术手段加入透明通道。参考这篇<a href="http://malideveloper.arm.com/resources/sample-code/etcv1-texture-compression-and-alpha-channels/" target="_blank" rel="noopener noreferrer">文章</a></p>
<h1>之前的准备</h1>
<p><img decoding="async" loading="lazy" src="http://malideveloper.arm.com/wp-content/uploads/2010/09/sample_code_alpha_seperate.jpg" alt="ETC1" class="img_ev3q"></p>
<p>我采用将一张纹理分割成两张图的方案,也就是<code>图片 = RGB部分纹理+Alpha部分纹理</code>。因为纹理大小由于硬件和操作系统原因是有限制的,<code>2048x2048</code>基本能被主流设备所认同，如果采用Alpha拼接的方式,原本2048的纹理最终大小会超过2048,如果所有纹理加上最大尺寸1024的限制又会使纹理数量增多.所以最终我选择了分割图片的方案。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="imagemagick">ImageMagick<a href="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx#imagemagick" class="hash-link" aria-label="ImageMagick的直接链接" title="ImageMagick的直接链接">​</a></h2>
<p>使用<a href="http://www.imagemagick.org/script/index.php" target="_blank" rel="noopener noreferrer">ImageMagick</a>来分割纹理的RGB和Alpha部分,为什么没有用<code>Mali GPU Texture Compression</code>直接生成呢?因为它生成的最终的<code>pkm</code>文件是经过压缩的,压缩率并不理想。所以后面我会介绍我使用<code>zlib</code>来压缩生成的<code>ETC1</code>格式的纹理。</p>
<p>分离RGB部分</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">convert logo.png </span><span class="token parameter variable" style="color:#E36209">-alpha</span><span class="token plain"> Off logo_rgb.png </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>分离Alpha部分</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">convert logo.png </span><span class="token parameter variable" style="color:#E36209">-channel</span><span class="token plain"> A </span><span class="token parameter variable" style="color:#E36209">-alpha</span><span class="token plain"> extract logo_a.png </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pvrtextool">PVRTexTool<a href="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx#pvrtextool" class="hash-link" aria-label="PVRTexTool的直接链接" title="PVRTexTool的直接链接">​</a></h2>
<p>使用<a href="https://community.imgtec.com/developers/powervr/tools/pvrtextool/" target="_blank" rel="noopener noreferrer">PVRTexTool</a>压缩ETC1纹理,注意这里生成的文件的后缀是<code>pvr</code>，其实它的格式是<code>ETC1</code></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PVRTexTool </span><span class="token parameter variable" style="color:#E36209">-f</span><span class="token plain"> ETC1 </span><span class="token parameter variable" style="color:#E36209">-i</span><span class="token plain"> logo_rgb.png </span><span class="token parameter variable" style="color:#E36209">-o</span><span class="token plain"> logo_rgb.pvr </span><span class="token parameter variable" style="color:#E36209">-q</span><span class="token plain"> etcfast</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PVRTexTool </span><span class="token parameter variable" style="color:#E36209">-f</span><span class="token plain"> ETC1 </span><span class="token parameter variable" style="color:#E36209">-i</span><span class="token plain"> logo_a.png </span><span class="token parameter variable" style="color:#E36209">-o</span><span class="token plain"> logo_a.pvr </span><span class="token parameter variable" style="color:#E36209">-q</span><span class="token plain"> etcfast</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在<code>logo_rgb.pvr</code>和<code>logo_a.pvr</code>已经是我们需要的<code>ETC1</code>格式的纹理了,但是你会发现它们比转换之前的文件大小大了很多:(
不能增加我们的包大小是不?所以我们先使用<code>zlib</code>来压缩下他们,为什么使用<code>zlib</code>? 因为2dx里已经有<code>zlib</code>库(记得iOS里的<code>xx.pvr</code>和<code>xx.pvr.ccz</code>吧,ccz其实就被zlib压缩过后的<code>PVRTC4</code>纹理),我们不用引入其他库,偷个懒:),当然我们也可以使用其他压缩算法，比如<code>梦幻西游</code>。听他们的开发说,使用的是<code>lzma</code>解压资源,但是它的解压速度会稍慢,但是压缩率比较高,这就需要你自己取舍了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="压缩纹理">压缩纹理<a href="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx#%E5%8E%8B%E7%BC%A9%E7%BA%B9%E7%90%86" class="hash-link" aria-label="压缩纹理的直接链接" title="压缩纹理的直接链接">​</a></h2>
<blockquote>
<p>我们需要一个工具,他能将纹理使用zlib压缩成一个2dx能识别的压缩格式,或者我们能在代码里能识别的文件.</p>
</blockquote>
<p>我们可以仿照pvr.ccz的策略,修改我们最终生成压缩文件的文件头信息,告诉2dx使用zlib来解压它。定义一个8个字节的结构体，表示我们的头信息.cpp中的结构体是连续的内存分配:)</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>前四个char分别为<code>!</code>,<code>E</code>,<code>T</code>,<code>C</code>,后面的<code>int</code>用来存储文件的原始大小。</p>
<p>最终的源码如下:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//  CompressETCTexture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//  Created by DannyHe on 9/16/15.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//  Copyright (c) 2015 DannyHe. All rights reserved.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#C6105F">"ETCCompress.h"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#C6105F">&lt;iostream&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#C6105F">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">namespace</span><span class="token plain"> std</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompress</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">compressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ZipHeaderInfo zipHeader</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> inFile </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"rb"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_END</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">ftell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> fileData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">'!'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">'E'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">'T'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">'C'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf destLength </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">compressBound</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pDestBuf </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> Bytef</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destLength</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> result </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">compress2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pDestBuf </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">destLength</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">fileData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> Z_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_MEM_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"ETCCompress:: note enough memory for compression"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_BUF_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"ETCCompress:: note enough room in buffer to compress the data"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"ETCCompress:: orignal size: "</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> fileSize </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" bytes"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" , compressed size : "</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> destLength </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" bytes"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" , header size: "</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" bytes"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" , final size : "</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> destLength </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" bytes"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" , compress ratio:"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> destLength</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">/</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">*</span><span class="token number" style="color:#005CC5">100</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"%"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token char">'\n'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> fo </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"wb+"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pDestBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">destLength</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">delete</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pDestBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uLongf </span><span class="token class-name" style="color:#116329">ETCCompress</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">unCompressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> packData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> packSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">buff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> packData</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'!'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'E'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'T'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'C'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"\nETCCompress:: header error"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> orginSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> headerSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf newSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> orginSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pUnBuf </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> Bytef</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">newSize</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> result2 </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">uncompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pUnBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">newSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">packData </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> headerSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">packSize </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> headerSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result2 </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> Z_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_MEM_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"ETCCompress:: note enough memory for uncompression"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_BUF_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"ETCCompress:: note enough room in buffer to uncompress the data"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buff </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> pUnBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"orignal size: "</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> packSize </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" bytes"</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" , ucompressed size : "</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> orginSize </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">" bytes"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token char">'\n'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> newSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompress</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">unCompressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> packFile </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"rb"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_END</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> packSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">ftell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> packData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">packSize</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> packSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> packFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pUnBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf newSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">unCompressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">packSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pUnBuf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newSize </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"\nETCCompress:: uncompress error!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> ft </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"wb+"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ft</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pUnBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">newSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ft</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ft</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">delete</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pUnBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>更多详细的代码及编译可以看我之前的<a href="http://dannyhe.wang/2015/12/15/how-to-copy-file-in-cmake/" target="_blank" rel="noopener noreferrer">这篇文章</a>和<a href="https://github.com/dannyjiajia/ETCCompress" target="_blank" rel="noopener noreferrer">仓库</a>
然后我们使用我们写的工具压缩我们的纹理</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CompressETCTexture pack logo_rgb.pvr logo_rgb.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CompressETCTexture pack logo_a.pvr logo_a.png</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后我们得到两个文件<code>logo_rgb.png</code>和<code>logo_a.png</code>,这两个文件经过了<code>ETC1</code>压缩并且文件大小也是我们能接受的范围,然后我们需要在<code>Cocos2dx</code>中使用他们。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2dx3x中解压">2dx(3.x)中解压<a href="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx#2dx3x%E4%B8%AD%E8%A7%A3%E5%8E%8B" class="hash-link" aria-label="2dx(3.x)中解压的直接链接" title="2dx(3.x)中解压的直接链接">​</a></h2>
<p>我们在<code>ZipUtils</code>类中加入我们的解压逻辑
头文件<code>ZipUtils.h</code>中声明我们的头信息结构体和解压函数</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">isETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">inflateETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实现解压</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">static_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">size_t</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'!'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'E'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'T'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">'C'</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t bufferLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> len </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#8250DF">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> len </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">CCLOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"cocos2d: ETCCompressed: Failed to allocate memory for texture"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf destlen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> ret </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">uncompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">destlen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">buffer </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bufferLen </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> ret </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> Z_OK </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">CCLOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"cocos2d: ETCCompressed: Failed to uncompress data"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后我们在2dx读取纹理文件的地方(<code>Image::initWithImageData</code>)调用我们的解压函数</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">CCLOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"Image: Use our etc format compressed!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> etcUnpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssize_t etcUnpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcUnpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//detecgt and unzip the compress file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isGZipBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#8250DF">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//detecgt and unzip the compress file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isGZipBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//detecgt and unzip the compress file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isGZipBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>2dx中使用ETC1</h1>
<p>我使用Shader来操作最中的Alpha,比如在<code>CCSprite</code>中，发现自己使用的纹理是<code>ETC1</code>格式便去查找Alpha纹理，如果发现便使用自己的Shader替换默认的Shader.
这样就做到对游戏以前的开发逻辑毫无修改。因为运用Shader的方式比较多，我这里就只列出我的Shader代码(CCSprite)</p>
<p>顶点不需要修改默认的</p>
<div class="language-glsl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glsl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> ccShader_etc1_PositionTextureColor_noMVP_vert </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">STRINGIFY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">attribute</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> a_position</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">attribute</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec2</span><span class="token plain"> a_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">attribute</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> a_color</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> v_fragmentColor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec2</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gl_Position </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> CC_PMatrix </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> a_position</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_fragmentColor </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> a_color</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_texCoord </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> a_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>片段着色</p>
<div class="language-glsl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glsl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">// u_texture1是etc的alpha数据也可以用ETC1压缩</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> ccShader_etc1_PositionTextureColor_noMVP_frag </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">STRINGIFY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> v_fragmentColor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec2</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">uniform</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sampler2D</span><span class="token plain"> u_texture1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> color </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">texture2D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CC_Texture0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">texture2D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u_texture1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gl_FragColor </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> color </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> v_fragmentColor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//支持Cocos opacity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用的话大概只需这样</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> program </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">GLProgramCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">getGLProgram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GLProgram</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">SHADER_NAME_ETC_ALPHA_POSITION_TEXTURE_COLOR_NO_MVP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//新加的etc shader</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> etc_program_state </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">GLProgramState</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etc_program_state</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">setUniformTexture</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"u_texture1"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> texture_alpha</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">setGLProgramState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etc_program_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>最后</h1>
<p>如果还需要优化包大小,可以采用将PNG转换成两张JPG,也是RGB+ALPHA.<code>刀塔传奇</code>就有使用这种策略。我们还可以直接压缩<code>png</code>,使它的画质降低,比如<a href="https://pngquant.org/" target="_blank" rel="noopener noreferrer">pngquant</a></p>
<p>另外上文中我们zlib压缩文件的小工具也可以来压缩其他文件,比如我们在<code>Windows Phone</code>平台使用的压缩纹理<code>DXT3</code>...
在发布<code>Android</code>的时候我们同样需要声明我们的游戏使用ETC压缩</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">&lt;!-- we want the device support etc1 texture format --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">supports-gl-texture</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name namespace" style="color:#0550AE;opacity:0.7">android:</span><span class="token tag attr-name" style="color:#0550AE">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">GL_OES_compressed_ETC1_RGB8_texture</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#22863A"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>zlib</category>
            <category>Cocos2dx</category>
            <category>Android</category>
            <category>ETC</category>
            <category>Optimize</category>
        </item>
        <item>
            <title><![CDATA[quick的ScrollView随想]]></title>
            <link>https://dannyjiajia.github.io/2016/think-about-scrollview</link>
            <guid>https://dannyjiajia.github.io/2016/think-about-scrollview</guid>
            <pubDate>Thu, 07 Jul 2016 15:27:13 GMT</pubDate>
            <description><![CDATA[一直使用quick。之前一直忙着做项目,都没有空停下来好好想想OpenGL的一些知识.今天和同事分析了下ClippingNode的实现,记录在这里。]]></description>
            <content:encoded><![CDATA[<p>一直使用<code>quick</code>。之前一直忙着做项目,都没有空停下来好好想想OpenGL的一些知识.今天和同事分析了下<code>ClippingNode</code>的实现,记录在这里。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="quick的尴尬">quick的尴尬<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#quick%E7%9A%84%E5%B0%B4%E5%B0%AC" class="hash-link" aria-label="quick的尴尬的直接链接" title="quick的尴尬的直接链接">​</a></h2>
<p>quick用裁剪测试,实现了一个lua版的<code>UIScrollView.lua</code>,可以满足简单的裁剪和滑动需求.</p>
<!-- -->
<div class="language-lua codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-lua codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">local</span><span class="token plain"> UIScrollView </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">class</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"UIScrollView"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> display</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#8250DF">newClippingRegionNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">end</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果我们需要滑动列表能嵌套(横(竖)向中嵌入竖(横)向的列表),这个列表就不能满足我们的需求了.</p>
<p><code>ClippingRectangleNode</code>的核心实现是根据OpenGL的裁剪测试</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">glEnable(GL_SCISSOR_TEST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">glScissor(x,y,width,height);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">glDisable(GL_SCISSOR_TEST);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="clippingnode原理">ClippingNode原理<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#clippingnode%E5%8E%9F%E7%90%86" class="hash-link" aria-label="ClippingNode原理的直接链接" title="ClippingNode原理的直接链接">​</a></h2>
<p><code>ClippingNode</code>采用模板测试实现裁剪,可实现裁剪的嵌套.这里分析它的实现步骤。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="模板测试">模板测试<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#%E6%A8%A1%E6%9D%BF%E6%B5%8B%E8%AF%95" class="hash-link" aria-label="模板测试的直接链接" title="模板测试的直接链接">​</a></h3>
<p>模板缓冲中的模板值(Stencil Value)通常是8位的，因此每个片段/像素共有256种不同的模板值，2dx在启动时便设置了这个值</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">GLViewImpl</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">initWithRect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain"> viewName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Rect rect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">float</span><span class="token plain"> frameZoomFactor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CGRect r </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">CGRectMake</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rect</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">convertAttrs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CCEAGLView </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">eaglview </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CCEAGLView viewWithFrame</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       pixelFormat</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NSString</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">_pixelFormat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       depthFormat</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> _depthFormat </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//iOS上设置深度测试和模板测试的参数为GL_DEPTH24_STENCIL8_OES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                preserveBackbuffer</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        sharegroup</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     multiSampling</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> NO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   numberOfSamples</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">eaglview setMultipleTouchEnabled</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain">YES</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _screenSize</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> _designResolutionSize</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">eaglview getWidth</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _screenSize</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> _designResolutionSize</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">eaglview getHeight</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//    _scaleX = _scaleY = [eaglview contentScaleFactor];</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _eaglview </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> eaglview</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>更多信息可以参考<a href="http://learnopengl-cn.readthedocs.io/zh/latest/04%20Advanced%20OpenGL/02%20Stencil%20testing/" target="_blank" rel="noopener noreferrer">这篇文章</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="一般情况不嵌套">一般情况(不嵌套)<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#%E4%B8%80%E8%88%AC%E6%83%85%E5%86%B5%E4%B8%8D%E5%B5%8C%E5%A5%97" class="hash-link" aria-label="一般情况(不嵌套)的直接链接" title="一般情况(不嵌套)的直接链接">​</a></h3>
<p>我们这里分析<code>_inverted</code>为<code>false</code>的情况,也就是保留裁剪区域内的内容的情况.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="onbeforevisit">onBeforeVisit<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#onbeforevisit" class="hash-link" aria-label="onBeforeVisit的直接链接" title="onBeforeVisit的直接链接">​</a></h4>
<p>开始绘制时,首先计算出这个<code>ClippingNode</code>的位遮罩(Bitmask)-<code>mask_layer</code></p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">// increment the current layer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s_layer</span><span class="token operator" style="color:#D73A49">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">// mask of the current layer (ie: for layer 3: 00000100)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GLint mask_layer </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0x1</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> s_layer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">// mask of all layers less than the current (ie: for layer 3: 00000011)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GLint mask_layer_l </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> mask_layer </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">// mask of all layers less than or equal to the current (ie: for layer 3: 00000111)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_mask_layer_le </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> mask_layer </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> mask_layer_l</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>s_layer = 0</p>
<p>mask_layer = 1</p>
<p>mask_layer_l = 0</p>
<p>_mask_layer_le = 1</p>
<p>然后保存下模板测试的当前的状态,接着开启模板测试，设置位遮罩</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">// enable stencil use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">glEnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GL_STENCIL_TEST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">// check for OpenGL error while enabling stencil test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">CHECK_GL_ERROR_DEBUG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">// all bits on the stencil buffer are readonly, except the current layer bit,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">// this means that operation like glClear or glStencilOp will be masked with this value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">glStencilMask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mask_layer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>glStencilMask</code>设置的值为<code>0x1</code>,就是告诉缓冲对模板值的最后一位是可写的。</p>
<p>接着清空模板缓冲中的值，设置结果为<code>GL_NEVER</code>,永远不通过,不通过时执行<code>GL_ZERO</code>操作(<code>_inverted</code>为<code>false</code>),绘制一个全屏的矩形</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">glStencilFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GL_NEVER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask_layer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask_layer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">glStencilOp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain">_inverted </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> GL_ZERO </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> GL_REPLACE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GL_KEEP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GL_KEEP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">drawFullScreenQuadClearStencil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此时模板缓冲中的值为,假设下面的矩阵表示了一个屏幕中的所有模板缓冲值.<strong>也就是一个0表示的是8位二进制结果<code>0x00000000</code></strong></p>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.16em" columnalign="center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{matrix} 0&amp;0&amp;0&amp;0&amp;0 \\\ 0&amp;0&amp;0&amp;0&amp;0 \\\ 0&amp;0&amp;0&amp;0&amp;0 \\\ 0&amp;0&amp;0&amp;0&amp;0 \\\ 0&amp;0&amp;0&amp;0&amp;0  \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.75em"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span></span></span></span></span></span></p></div></div>
<p>然后开始准备画我们的<code>蒙版</code>,仍然是测试永远不通过,如果不通过执行<code>mask_layer</code>(0x1)的最后一位<code>替换</code>到模板值的最后一位</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">glStencilFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GL_NEVER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask_layer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mask_layer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">glStencilOp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain">_inverted </span><span class="token operator" style="color:#D73A49">?</span><span class="token plain"> GL_REPLACE </span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"> GL_ZERO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GL_KEEP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GL_KEEP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后模板缓冲中的值为</p>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.16em" columnalign="center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{matrix} 0&amp;0&amp;0&amp;0&amp;0 \\\ 0&amp;1&amp;1&amp;1&amp;0 \\\ 0&amp;1&amp;1&amp;1&amp;0 \\\ 0&amp;1&amp;1&amp;1&amp;0 \\\ 0&amp;0&amp;0&amp;0&amp;0  \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.75em"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span></span></span></span></span></span></p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="onafterdrawstencil">onAfterDrawStencil<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#onafterdrawstencil" class="hash-link" aria-label="onAfterDrawStencil的直接链接" title="onAfterDrawStencil的直接链接">​</a></h4>
<p>在<code>蒙版</code>绘制完后,开始绘制子节点前设置测试操作</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">glStencilFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GL_EQUAL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _mask_layer_le</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _mask_layer_le</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">glStencilOp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GL_KEEP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GL_KEEP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GL_KEEP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>保留满足公式<code>(模板值 &amp; _mask_layer_le) == (_mask_layer_le &amp; _mask_layer_le)</code>的模板值片段,也就是上面图中得所有1位置的片段,也就是我们<code>蒙版</code>中的图像.<code>模板值 &amp; 1 == 1</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="onaftervisit">onAfterVisit<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#onaftervisit" class="hash-link" aria-label="onAfterVisit的直接链接" title="onAfterVisit的直接链接">​</a></h4>
<p>最后还原一开始保留的模板测试的状态,关闭模板测试</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ClippingNode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">onAfterVisit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">DIRECTX_ENABLED </span><span class="token macro property expression operator" style="color:#D73A49">==</span><span class="token macro property expression" style="color:#005CC5"> </span><span class="token macro property expression number" style="color:#005CC5">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">///////////////////////////////////</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// CLEANUP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// manually restore the stencil state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">glStencilFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_currentStencilFunc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _currentStencilRef</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _currentStencilValueMask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">glStencilOp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_currentStencilFail</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _currentStencilPassDepthFail</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _currentStencilPassDepthPass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">glStencilMask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_currentStencilWriteMask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain">_currentStencilEnabled</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">glDisable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GL_STENCIL_TEST</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">// we are done using this layer, decrement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s_layer</span><span class="token operator" style="color:#D73A49">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="嵌套的情况">嵌套的情况<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#%E5%B5%8C%E5%A5%97%E7%9A%84%E6%83%85%E5%86%B5" class="hash-link" aria-label="嵌套的情况的直接链接" title="嵌套的情况的直接链接">​</a></h3>
<p>我们假设上面的<code>ClippingNode</code>有一个<code>ClippingNode</code>类型的<code>child</code>
先绘制父节点,然后才绘制子节点<code>ClippingNode</code>
也就是在父节点执行绘制子节点的时候,子节点<code>ClippingNode</code>会有下面的步骤</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="onbeforevisit-1">onBeforeVisit<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#onbeforevisit-1" class="hash-link" aria-label="onBeforeVisit的直接链接" title="onBeforeVisit的直接链接">​</a></h4>
<p>s_layer = 1</p>
<p>mask_layer = 2</p>
<p>mask_layer_l = 1</p>
<p>_mask_layer_le = 3</p>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.16em" columnalign="center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{matrix} 0&amp;0&amp;0&amp;0&amp;0 \\\ 0&amp;1&amp;1&amp;1&amp;0 \\\ 2&amp;3&amp;3&amp;3&amp;2 \\\ 0&amp;1&amp;1&amp;1&amp;0 \\\ 0&amp;0&amp;0&amp;0&amp;0  \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.75em"></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">2</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em"><span style="top:-5.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-0.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em"><span></span></span></span></span></span></span></span></span></span></span></p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="onafterdrawstencil-1">onAfterDrawStencil<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#onafterdrawstencil-1" class="hash-link" aria-label="onAfterDrawStencil的直接链接" title="onAfterDrawStencil的直接链接">​</a></h4>
<p><code>(模板值 &amp; _mask_layer_le) == (_mask_layer_le &amp; _mask_layer_le)</code> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\to</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em"></span><span class="mrel">→</span></span></span></span> <code>(模板值 &amp; 3) == (3 &amp; 3)</code>
也就是只有模板值为<code>3</code>的片段会被保留</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="最后">最后<a href="https://dannyjiajia.github.io/2016/think-about-scrollview#%E6%9C%80%E5%90%8E" class="hash-link" aria-label="最后的直接链接" title="最后的直接链接">​</a></h2>
<p><del>猜测下iOS中的<code>UIScrollView</code>也是基于模板测试,当然有可能不嵌套的时候也是使用的<code>glScissor</code>,毕竟模板测试会多两次drawcall.</del>
最后如何改造<code>qucik</code>的<code>UIScrollView.lua</code></p>
<ol>
<li>
<p>继承<code>cc.ClippingNode</code></p>
</li>
<li>
<p><code>setViewRect</code>的实现修改为设置<code>setStencil</code></p>
</li>
<li>
<p>将<code>addTouchNode</code>中<code>node</code>设置为传递事件<code>setTouchSwallowEnabled(false)</code></p>
</li>
</ol>]]></content:encoded>
            <category>iOS</category>
            <category>OpenGL</category>
            <category>Cocos2dx</category>
        </item>
        <item>
            <title><![CDATA[Core Graphics和OpenGL里的矩阵运算]]></title>
            <link>https://dannyjiajia.github.io/2016/matrix-ios-and-opengl.mdx</link>
            <guid>https://dannyjiajia.github.io/2016/matrix-ios-and-opengl.mdx</guid>
            <pubDate>Mon, 04 Jul 2016 16:19:19 GMT</pubDate>
            <description><![CDATA[总结下iOS和OpenGL里的矩阵计算]]></description>
            <content:encoded><![CDATA[<p>总结下iOS和OpenGL里的矩阵计算</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ios-core-graphics">iOS (Core Graphics)<a href="https://dannyjiajia.github.io/2016/matrix-ios-and-opengl.mdx#ios-core-graphics" class="hash-link" aria-label="iOS (Core Graphics)的直接链接" title="iOS (Core Graphics)的直接链接">​</a></h4>
<p>iOS里面的矩阵用行向量表示,所以是矩阵右乘向量.</p>
<p>以<code>Quartz 2D</code>举例平移,因为是2d所以是一个3x3的矩阵,3d就是4x4</p>
<blockquote>
<p>补充:有朋友问我这里为什么变成了3x3的矩阵?3d则是4x4?</p>
</blockquote>
<blockquote>
<p>这里使用的齐次坐标。图形学引入齐次坐标的目的主要是合并矩阵运算中的乘法和加法，表示为p' = p*M的形式。即它提供了用矩阵运算把二维、三维甚至高维空间中的一个点集从一个坐标系变换到另一个坐标系的有效方法。</p>
</blockquote>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>x</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>y</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>c</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>d</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><msub><mi>t</mi><mi>x</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>t</mi><mi>y</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>x</mi><mo>+</mo><mi>c</mi><mi>y</mi><mo>+</mo><msub><mi>t</mi><mi>x</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>b</mi><mi>x</mi><mo>+</mo><mi>d</mi><mi>y</mi><mo>+</mo><msub><mi>t</mi><mi>y</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix} x&amp;y&amp;1 \end{bmatrix} \cdot  \begin{bmatrix} a&amp;b&amp;0 \\\ c&amp;d&amp;0 \\\ t_x&amp;t_y&amp;1 \end{bmatrix} = \begin{bmatrix} ax+cy+t_x&amp;bx+dy+t_y&amp;1 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">]</span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.05em"><span class="pstrut" style="height:5.6em"></span><span style="width:0.667em;height:3.600em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">a</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">c</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">b</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.05em"><span class="pstrut" style="height:5.6em"></span><span style="width:0.667em;height:3.600em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.03588em">cy</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">b</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">]</span></span></span></span></span></span></p></div></div>
<p>所以<code>CGAffineTransform CGAffineTransformMakeTranslation ( CGFloat tx, CGFloat ty );</code>是上面的公式中的
<code>a=d=1</code>和<code>b=c=0</code></p>
<p>也就是矩阵</p>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mn>0</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><msub><mi>t</mi><mi>x</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>t</mi><mi>y</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} 1&amp;0&amp;0 \\\ 0&amp;1&amp;0 \\\ t_x&amp;t_y&amp;1 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.05em"><span class="pstrut" style="height:5.6em"></span><span style="width:0.667em;height:3.600em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em"><span style="top:-4.05em"><span class="pstrut" style="height:5.6em"></span><span style="width:0.667em;height:3.600em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewBox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em"><span></span></span></span></span></span></span></span></span></span></span></p></div></div>
<p><strong>如果我们把这个公式用于3d</strong> 则是<code>CATransform3D</code></p>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>x</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>y</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>z</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>11</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>12</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>13</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>14</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>m</mi><mn>21</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>22</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>23</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>24</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>m</mi><mn>31</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>32</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>33</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>34</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>m</mi><mn>41</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>42</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>43</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>m</mi><mn>44</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>z</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix} x&amp;y&amp;z&amp;1 \end{bmatrix} \cdot \begin{bmatrix} m11&amp;m12&amp;m13&amp;m14 \\\ m21&amp;m22&amp;m23&amp;m24 \\\ m31&amp;m32&amp;m33&amp;m34 \\\ m41&amp;m42&amp;m43&amp;m44 \end{bmatrix} = \begin{bmatrix} x'&amp;y'&amp;z'&amp;1 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">]</span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">11</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">m</span><span class="mord">21</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">m</span><span class="mord">31</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">m</span><span class="mord">41</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">12</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">22</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">32</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">42</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">13</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">23</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">33</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">43</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">14</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">24</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">34</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="mord">44</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em"></span><span class="minner"><span class="mopen delimcenter" style="top:0em"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em"><span style="top:-3.01em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em"><span class="delimsizing size1">]</span></span></span></span></span></span></p></div></div>
<p><code>m34</code>可以影响投影矩阵设置为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mo>−</mo><mn>1</mn></mrow><mi>d</mi></mfrac></mrow><annotation encoding="application/x-tex">-1 \over d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>表示向<code>z=d</code>的平面进行透视投影</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="opengl">OpenGL<a href="https://dannyjiajia.github.io/2016/matrix-ios-and-opengl.mdx#opengl" class="hash-link" aria-label="OpenGL的直接链接" title="OpenGL的直接链接">​</a></h4>
<p>OpenGL使用列向量表示,所以是矩阵左乘向量.</p>
<div class="browserWindow_my1Q"><div class="browserWindowHeader_jXSR"><div class="buttons_uHc7"><span class="dot_giz1" style="background:#f25f58"></span><span class="dot_giz1" style="background:#fbbe3c"></span><span class="dot_giz1" style="background:#58cb42"></span></div><div class="browserWindowAddressBar_Pd8y text--truncate">http://localhost:3000</div><div class="browserWindowMenuIcon_Vhuh"><div><span class="bar_rrRL"></span><span class="bar_rrRL"></span><span class="bar_rrRL"></span></div></div></div><div class="browserWindowBody_Idgs"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>c</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>d</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>e</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>f</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>g</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>h</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>i</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>j</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>k</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>l</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>m</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>n</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>o</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>p</mi></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>⋅</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>x</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>z</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>w</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>x</mi><mo>+</mo><mi>b</mi><mi>y</mi><mo>+</mo><mi>c</mi><mi>z</mi><mo>+</mo><mi>d</mi><mi>w</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>e</mi><mi>x</mi><mo>+</mo><mi>f</mi><mi>y</mi><mo>+</mo><mi>g</mi><mi>z</mi><mo>+</mo><mi>h</mi><mi>w</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>i</mi><mi>x</mi><mo>+</mo><mi>j</mi><mi>y</mi><mo>+</mo><mi>k</mi><mi>z</mi><mo>+</mo><mi>l</mi><mi>w</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>&nbsp;</mtext><mi>m</mi><mi>x</mi><mo>+</mo><mi>n</mi><mi>y</mi><mo>+</mo><mi>o</mi><mi>z</mi><mo>+</mo><mi>p</mi><mi>w</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix} a&amp;b&amp;c&amp;d \\\ e&amp;f&amp;g&amp;h \\\ i&amp;j&amp;k&amp;l \\\ m&amp;n&amp;o&amp;p \end{bmatrix} \cdot \begin{bmatrix} x\\\ y \\\ z \\\ w \end{bmatrix} = \begin{bmatrix} ax+by+cz+dw \\\ ex+fy+gz+hw \\\ ix+jy+kz+lw \\\ mx+ny+oz+pw\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">a</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">e</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">i</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">b</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05724em">j</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">c</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">g</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em"></span><span class="arraycolsep" style="width:0.5em"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">h</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em">l</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M403 1759 V84 H666 V0 H319 V1759 v1200 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.81em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.04398em">cz</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span></span></span><span style="top:-3.61em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02691em">w</span></span></span><span style="top:-2.41em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.05724em">j</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.02691em">lw</span></span></span><span style="top:-1.21em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mspace">&nbsp;</span><span class="mord mathnormal">m</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.04398em">oz</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord mathnormal" style="margin-right:0.02691em">pw</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em"><span style="top:-4.65em"><span class="pstrut" style="height:6.8em"></span><span style="width:0.667em;height:4.800em"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="4.800em" viewBox="0 0 667 4800"><path d="M347 1759 V0 H0 V84 H263 V1759 v1200 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1200 v1759 h84z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em"><span></span></span></span></span></span></span></span></span></span></span></span></div></div>
<p>OpenGL的透视投影计算可以参考<a href="http://www.360doc.com/content/14/1028/10/19175681_420522154.shtml" target="_blank" rel="noopener noreferrer">这篇文章</a></p>]]></content:encoded>
            <category>iOS</category>
            <category>OpenGL</category>
        </item>
        <item>
            <title><![CDATA[(cpp)cx中将string转换成GUID]]></title>
            <link>https://dannyjiajia.github.io/2016/cpp-convert-string-to-guid</link>
            <guid>https://dannyjiajia.github.io/2016/cpp-convert-string-to-guid</guid>
            <pubDate>Fri, 24 Jun 2016 15:06:05 GMT</pubDate>
            <description><![CDATA[~~~cpp]]></description>
            <content:encoded><![CDATA[<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#C6105F">&lt;windows.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">namespace</span><span class="token plain"> Windows</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">ApplicationModel</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">namespace</span><span class="token plain"> Windows</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Foundation</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">namespace</span><span class="token plain"> Windows</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Foundation</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Collections</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Platform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">String</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> transactionId </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"{xxxxx}"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//从微软的内购中获取的订单号字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GUID guid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HRESULT hr </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">IIDFromString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">transactionId</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">Data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">guid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">SUCCEEDED</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Platform</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Guid </span><span class="token function" style="color:#8250DF">guid_transactionId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">guid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> fuillAsync </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">CurrentApp</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">ReportConsumableFulfillmentAsync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">productId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> guid_transactionId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//完成订单</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Windows Phone</category>
        </item>
        <item>
            <title><![CDATA[GCD与RunLoop]]></title>
            <link>https://dannyjiajia.github.io/2016/gcd-and-runloop</link>
            <guid>https://dannyjiajia.github.io/2016/gcd-and-runloop</guid>
            <pubDate>Fri, 24 Jun 2016 10:33:15 GMT</pubDate>
            <description><![CDATA[最近发现iOS中的RunLoop和GCD被讨论的挺多的,我也写点复习下:)]]></description>
            <content:encoded><![CDATA[<p>最近发现iOS中的RunLoop和GCD被讨论的挺多的,我也写点复习下:)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gcd">GCD<a href="https://dannyjiajia.github.io/2016/gcd-and-runloop#gcd" class="hash-link" aria-label="GCD的直接链接" title="GCD的直接链接">​</a></h3>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">import</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression operator" style="color:#D73A49">&lt;</span><span class="token macro property expression" style="color:#005CC5">Foundation</span><span class="token macro property expression operator" style="color:#D73A49">/</span><span class="token macro property expression" style="color:#005CC5">Foundation</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#005CC5">h</span><span class="token macro property expression operator" style="color:#D73A49">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_queue_t globalQ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_get_global_queue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** 异步任务 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"async task"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** 同步任务 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_sync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"sync task"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"sync end"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** 一次性执行 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> dispatch_once_t onceToken</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_once</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">onceToken</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"once task"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/**  延迟 2 秒执行 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">double</span><span class="token plain"> delayInSeconds </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">2.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_time_t popTime </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DISPATCH_TIME_NOW</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> delayInSeconds </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> NSEC_PER_SEC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_after</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">popTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"delay task"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** global queue是并行的 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"global_queue_task_1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"global_queue_task_2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** 自定义串行queue **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_queue_t customSerialQ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_queue_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"customSerialQ"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DISPATCH_QUEUE_SERIAL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customSerialQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"customSerialQ_task_1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customSerialQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"customSerialQ_task_2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** 自定义并行queue **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_queue_t customConcurrentQ </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_queue_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">"customConcurrentQ"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DISPATCH_QUEUE_CONCURRENT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customConcurrentQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"customConcurrentQ_task_1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">customConcurrentQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"customConcurrentQ_task_2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** 并行任务归总 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_group_t group </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_group_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_group_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"并行执行的线程1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_group_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"并行执行的线程2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_group_notify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"并行执行任务完成"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** dispatch_source **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//1. timer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_source_t gcd_timer </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_source_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DISPATCH_SOURCE_TYPE_TIMER</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">globalQ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_source_set_timer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gcd_timer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DISPATCH_TIME_NOW</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">5ull</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> NSEC_PER_SEC</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//5s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_source_set_event_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gcd_timer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"gcd timer task"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_resume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gcd_timer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//2. 自定义source任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_source_t gcd_source </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_source_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DISPATCH_SOURCE_TYPE_DATA_ADD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">globalQ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_source_set_event_handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gcd_source</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"gcd source task"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_resume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gcd_source</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//2s后触发source任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_after</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">popTime</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"fire gcd source task"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">dispatch_source_merge_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gcd_source</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">/** 信号量 **/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_semaphore_t semaphore </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_semaphore_create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_async</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">globalQ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">^</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"完成信号量任务"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">dispatch_semaphore_signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">semaphore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#6B6B6B;font-style:italic">//增加信号量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//设置超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_time_t timeoutTime </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">dispatch_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DISPATCH_TIME_NOW</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1ull</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">NSEC_PER_SEC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#8250DF">dispatch_semaphore_wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">semaphore</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timeoutTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"信号量任务超时"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">dispatch_main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//执行提交到main queue中的blocks,在iOS和Mac的桌面应用你不需要调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="runloop">RunLoop<a href="https://dannyjiajia.github.io/2016/gcd-and-runloop#runloop" class="hash-link" aria-label="RunLoop的直接链接" title="RunLoop的直接链接">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#import &lt;Foundation/Foundation.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_perform(void *info __unused)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf("Source0 event\n");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static void</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_timer(CFRunLoopTimerRef timer __unused, void *info)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSLog(@"Timer fire Source0");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopSourceSignal(info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** 注册observer **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopRef runLoop = CFRunLoopGetCurrent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFStringRef runLoopMode = kCFRunLoopDefaultMode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopObserverRef observer = CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopAllActivities, true, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity _) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NSLog(@"observer event:%lu",_);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopAddObserver(runLoop, observer, runLoopMode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** Source 0 **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopSourceRef source;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopSourceContext source_context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bzero(&amp;source_context, sizeof(source_context));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source_context.perform = _perform;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source = CFRunLoopSourceCreate(NULL, 0, &amp;source_context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopAddSource(CFRunLoopGetCurrent(), source, kCFRunLoopDefaultMode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //2s后触发source0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, 2 * NSEC_PER_SEC), dispatch_get_main_queue(), ^(void){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CFRunLoopSourceSignal(source);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /** Timer **/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopTimerRef timer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopTimerContext timer_context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bzero(&amp;timer_context, sizeof(timer_context));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timer_context.info = source;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timer = CFRunLoopTimerCreate(NULL, CFAbsoluteTimeGetCurrent(), 5, 0, 0,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 _timer, &amp;timer_context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopAddTimer(CFRunLoopGetCurrent(), timer, kCFRunLoopDefaultMode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CFRunLoopRun();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="我的总结">我的总结<a href="https://dannyjiajia.github.io/2016/gcd-and-runloop#%E6%88%91%E7%9A%84%E6%80%BB%E7%BB%93" class="hash-link" aria-label="我的总结的直接链接" title="我的总结的直接链接">​</a></h3>
<ul>
<li>系统通过RunLoop执行主队列中的任务,这个RunLoop由<code>UIApplicationMain</code>或者<code>NSApplicationMain</code>或者<code>CFRunLoopRun</code>创建</li>
<li>两个不同的Timer,<code>NSTimer</code>依赖RunLoop来执行,GCD的Timer不需要RunLoop存在也能执行</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="最后">最后<a href="https://dannyjiajia.github.io/2016/gcd-and-runloop#%E6%9C%80%E5%90%8E" class="hash-link" aria-label="最后的直接链接" title="最后的直接链接">​</a></h3>
<p>写的用例都是在Mac的命令行项目下测试的,感觉更能说明RunLoop的真实运行状态,比如测试<code>NSTimer</code>,如果不执行<code>CFRunLoopRun</code>,主线程是没有<code>RunLoop</code>的,<code>NSTimer</code>也会失效,而在<code>iOS</code>项目中,整个生命周期都是基于RunLoop,<code>NSTimer</code>也不会出现无效的情况.(指定特殊<code>Mode</code>的任务除外)</p>]]></content:encoded>
            <category>GCD</category>
            <category>RunLoop</category>
            <category>iOS</category>
        </item>
        <item>
            <title><![CDATA[如何计算git变动的文件大小]]></title>
            <link>https://dannyjiajia.github.io/2016/calculate-git-changed-file-size</link>
            <guid>https://dannyjiajia.github.io/2016/calculate-git-changed-file-size</guid>
            <pubDate>Thu, 12 May 2016 16:35:26 GMT</pubDate>
            <description><![CDATA[~~~bash]]></description>
            <content:encoded><![CDATA[<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic"># The tool to get the total size of autoupdate </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic"># by Dannyhe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#8250DF">NotSupport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token builtin class-name" style="color:#116329">echo</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"Not support </span><span class="token string environment constant" style="color:#005CC5">$OSTYPE</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token builtin class-name" style="color:#116329">exit</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">function</span><span class="token plain"> </span><span class="token function-name function" style="color:#8250DF">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token builtin class-name" style="color:#116329">echo</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"os: </span><span class="token string environment constant" style="color:#005CC5">$OSTYPE</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token builtin class-name" style="color:#116329">echo</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"size:"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string environment constant" style="color:#005CC5">$OSTYPE</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"linux-gnu"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	     NotSupport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">elif</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string environment constant" style="color:#005CC5">$OSTYPE</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"darwin"</span><span class="token plain">* </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Mac OSX</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	     </span><span class="token function" style="color:#8250DF">git</span><span class="token plain"> log --name-status </span><span class="token parameter variable" style="color:#E36209">-1</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-E</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'^[A-Z]\b'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sort</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-k</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">2,2</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-u</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-E</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"M|A"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">awk</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'{print $2}'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">xargs</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">stat</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-f</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"%z"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">awk</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'{t+=$0}END{print t/(1024*1024)" Mb"}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">elif</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string environment constant" style="color:#005CC5">$OSTYPE</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"cygwin"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># POSIX compatibility layer and Linux environment emulation for WindowsNotSupport</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NotSupport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">elif</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string environment constant" style="color:#005CC5">$OSTYPE</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"msys"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic"># Lightweight shell and GNU utilities compiled for Windows (part of MinGW)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">git</span><span class="token plain"> log --name-status </span><span class="token parameter variable" style="color:#E36209">-1</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-E</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'^[A-Z]\b'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">sort</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-k</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">2,2</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-u</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">grep</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-E</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"M|A"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">awk</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'{print $2}'</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">xargs</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">du</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-b</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">|</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">awk</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">'{t+=$0}END{print t/(1024*1024)" Mb"}'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">elif</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"</span><span class="token string environment constant" style="color:#005CC5">$OSTYPE</span><span class="token string" style="color:#C6105F">"</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">"freebsd"</span><span class="token plain">* </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		NotSupport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		NotSupport</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>git</category>
            <category>shell</category>
        </item>
        <item>
            <title><![CDATA[Sublime Text 3 License Key - CRACK]]></title>
            <link>https://dannyjiajia.github.io/2016/sublime_crack</link>
            <guid>https://dannyjiajia.github.io/2016/sublime_crack</guid>
            <pubDate>Sun, 01 May 2016 14:52:56 GMT</pubDate>
            <description><![CDATA[Sublime Text 3 Build 3103 License Key - CRACK]]></description>
            <content:encoded><![CDATA[<p>Sublime Text 3 Build 3103 License Key - CRACK</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">—– BEGIN LICENSE —–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Michael Barnes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Single User License</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EA7E-821385</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8A353C41 872A0D5C DF9B2950 AFF6F667</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C458EA6D 8EA3C286 98D1D650 131A97AB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AA919AEC EF20E143 B361B1E7 4C8B7F04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B085E65E 2F5F5360 8489D422 FB8FC1AA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">93F6323C FD7F7544 3F39C318 D95E6480</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCCC7561 8A4A1741 68FA4223 ADCEDE07</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">200C25BE DBBC4855 C4CFB774 C5EC138C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0FEC1CEF D9DCECEC D3A5DAD1 01316C36</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">—— END LICENSE ——</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">—– BEGIN LICENSE —–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nicolas Hennion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Single User License</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EA7E-866075</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8A01AA83 1D668D24 4484AEBC 3B04512C</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">827B0DE5 69E9B07A A39ACCC0 F95F5410</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">729D5639 4C37CECB B2522FB3 8D37FDC1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">72899363 BBA441AC A5F47F08 6CD3B3FE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CEFB3783 B2E1BA96 71AAF7B4 AFB61B1D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0CC513E7 52FF2333 9F726D2C CDE53B4A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">810C0D4F E1F419A3 CDA0832B 8440565A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">35BF00F6 4CA9F869 ED10E245 469C233E</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">—— END LICENSE ——</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">—– BEGIN LICENSE —–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Anthony Sansone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Single User License</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EA7E-878563</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">28B9A648 42B99D8A F2E3E9E0 16DE076E</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E218B3DC F3606379 C33C1526 E8B58964</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B2CB3F63 BDF901BE D31424D2 082891B5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">F7058694 55FA46D8 EFC11878 0868F093</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">B17CAFE7 63A78881 86B78E38 0F146238</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BAE22DBB D4EC71A1 0EC2E701 C7F9C648</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5CF29CA3 1CB14285 19A46991 E9A98676</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">14FD4777 2D8A0AB6 A444EE0D CA009B54</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">—— END LICENSE ——</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">—– BEGIN LICENSE —–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Alexey Plutalov</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Single User License</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EA7E-860776</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3DC19CC1 134CDF23 504DC871 2DE5CE55</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">585DC8A6 253BB0D9 637C87A2 D8D0BA85</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AAE574AD BA7D6DA9 2B9773F2 324C5DEF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">17830A4E FBCF9D1D 182406E9 F883EA87</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E585BBA1 2538C270 E2E857C2 194283CA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7234FF9E D0392F93 1D16E021 F1914917</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">63909E12 203C0169 3F08FFC8 86D06EA8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">73DDAEF0 AC559F30 A6A67947 B60104C6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">—— END LICENSE ——</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Sublime</category>
        </item>
        <item>
            <title><![CDATA[rsync在Windows上的权限问题]]></title>
            <link>https://dannyjiajia.github.io/2016/about-rsync</link>
            <guid>https://dannyjiajia.github.io/2016/about-rsync</guid>
            <pubDate>Wed, 13 Apr 2016 09:46:24 GMT</pubDate>
            <description><![CDATA[~~~shell]]></description>
            <content:encoded><![CDATA[<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#8250DF">rsync</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">-ravc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">--exclude</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">.DS_Store* </span><span class="token parameter variable" style="color:#E36209">--exclude</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">.git/ </span><span class="token parameter variable" style="color:#E36209">--exclude</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">.gitignore 源路径 目标路径 --delete-after </span><span class="token parameter variable" style="color:#E36209">--perms</span><span class="token plain"> </span><span class="token parameter variable" style="color:#E36209">--chmod</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">a</span><span class="token operator" style="color:#D73A49">=</span><span class="token plain">rw,Da+x</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>shell</category>
        </item>
        <item>
            <title><![CDATA[对Android的Gradle插件的理解]]></title>
            <link>https://dannyjiajia.github.io/2016/think-about-android-gradle</link>
            <guid>https://dannyjiajia.github.io/2016/think-about-android-gradle</guid>
            <pubDate>Mon, 28 Mar 2016 19:26:48 GMT</pubDate>
            <description><![CDATA[本来打算写一篇关于Android的gradle插件的使用详解之类的文章,结果在知乎看到了一篇不错的。我在这里总结下吧。]]></description>
            <content:encoded><![CDATA[<p>本来打算写一篇关于Android的gradle插件的使用详解之类的文章,结果在知乎看到了一篇不错的。我在这里总结下吧。</p>
<p><a href="http://ghui.me/post/2015/03/create-several-variants" target="_blank" rel="noopener noreferrer">http://ghui.me/post/2015/03/create-several-variants</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="开始">开始<a href="https://dannyjiajia.github.io/2016/think-about-android-gradle#%E5%BC%80%E5%A7%8B" class="hash-link" aria-label="开始的直接链接" title="开始的直接链接">​</a></h3>
<ol>
<li>
<p>合并的思想</p>
<p>新的构建系统最主要的想法就是合并,将各自<code>Productflavor</code>定义的不同项目配置(applicationId,versionCode,signingConfig,sourceSets...)以及资源(java代码,AndroidManifest.xml,res,jni...)和公用的<code>defaultConfig</code>定义的配置、<code>sourceSets.main</code>定义的资源进行合并</p>
</li>
</ol>
<ol start="2">
<li>
<p>applicationId和AndroidManifest.xml中的package</p>
<p>applicationId用来在Android设备和Google Play来区分apk,也就是以前的package.而现在AndroidManifest.xml中的package仅用来生成R.java</p>
</li>
<li>
<p>各自的Productflavor可以显式的设置sourceSets</p>
<p>不要误以为每个Productflavor对应的java代码目录和资源目录是定死的,可以通过sourceSets.flavor来自定义,如果没有显式定义才是如上文中所说的路径.如:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sourceSets.flavor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    java.srcDir "src-flavor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    res.srcDir "res-flavor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jniLibs.srcDir "libs-flavor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    manifest.srcFile "AndroidManifestflavor.xml"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assets.srcDir "assets-flavor"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>各自的Productflavor下不要定义和<code>main</code>中同名的java类</p>
</li>
<li>
<p>packagingOptions的不足</p>
<p>packagingOptions虽然可以取消掉一些so文件的引用,但是暂时还不能做到对不同的<code>Productflavor</code>进行设置,可以通过第三方插件<a href="https://github.com/Jween/android-soexcluder" target="_blank" rel="noopener noreferrer">https://github.com/Jween/android-soexcluder</a></p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="自己的方案">自己的方案<a href="https://dannyjiajia.github.io/2016/think-about-android-gradle#%E8%87%AA%E5%B7%B1%E7%9A%84%E6%96%B9%E6%A1%88" class="hash-link" aria-label="自己的方案的直接链接" title="自己的方案的直接链接">​</a></h3>
<p>我采用的是同一份java代码,同一个静态库,不同的资源目录,不同的<code>AndroidManifest.xml</code>文件.java代码通过<code>ant</code>插件的宏定义分别生成不同的java代码(只是在编译时).这样就达到了灵活打包的特点,根据不同的宏定义定制出不同的apk,代码始终维护一份</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置">配置<a href="https://dannyjiajia.github.io/2016/think-about-android-gradle#%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="配置的直接链接" title="配置的直接链接">​</a></h4>
<p>使用ant的插件<a href="http://antenna.sourceforge.net/wtkpreprocess.php" target="_blank" rel="noopener noreferrer">antenna</a>,下载后将jar包放在项目目录下的<code>tools</code>目录中,然后在<code>build.gradle</code>中配置</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">def FreeMarcos = "FREE_VERSION"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ant.properties['wtk.home'] = "tools"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ant.taskdef( name: "wtkpreprocess", classname: "de.pleumann.antenna.WtkPreprocess", classpath:"../tools/antenna-bin-1.0.2.jar")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">task PreprocessFree {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  inputs.dir "src"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  outputs.dir "src"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  doLast {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ant.wtkpreprocess(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          srcdir: "src",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          destdir: "src", </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          verbose:true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          printsymbols:true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          debuglevel:"debug",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          encoding:"UTF-8",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          symbols:FreeMarcos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>也可以用ant的方式来配置,可以看<a href="http://dannyhe.wang/2016/01/31/use-ant-in-gradle" target="_blank" rel="noopener noreferrer">这篇文章</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="使用">使用<a href="https://dannyjiajia.github.io/2016/think-about-android-gradle#%E4%BD%BF%E7%94%A8" class="hash-link" aria-label="使用的直接链接" title="使用的直接链接">​</a></h4>
<p>比如在java代码里这样使用:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public void buy(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//#ifdef FREE_VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pay(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//#else </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      pay(100.0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行gradle task:<code>gradle PreprocessFree</code>,然后重新打开上面的代码文件,就能看见源码的变化了:)</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="最后">最后<a href="https://dannyjiajia.github.io/2016/think-about-android-gradle#%E6%9C%80%E5%90%8E" class="hash-link" aria-label="最后的直接链接" title="最后的直接链接">​</a></h4>
<p>将上面的<code>PreprocessFree</code>任务加到对应的<code>Productflavor</code>编译中,这样在我们每次执行<code>assemble</code>任务的时候,便会自动执行代码的生成任务。</p>
<p>比如我定义的flavor为<code>free</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">android.applicationVariants.all { variant -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  variant.productFlavors.each { flavor -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (flavor.name.equals('free')) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          variant.javaCompile.dependsOn(PreprocessFree)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以定义多个<code>flavor</code>和多个Preprocess任务,不同的<code>flavor</code>使用不同的java源码,这就实现了多个版本的需求，而且也不需要将源码分目录放了。
happy coding :)</p>]]></content:encoded>
            <category>Android</category>
            <category>Android Studio</category>
            <category>Gradle</category>
            <category>Ant</category>
            <category>Antenna</category>
        </item>
        <item>
            <title><![CDATA[谈谈next主题如何添加"Fork me on Github"]]></title>
            <link>https://dannyjiajia.github.io/2016/github-link-with-next</link>
            <guid>https://dannyjiajia.github.io/2016/github-link-with-next</guid>
            <pubDate>Sat, 12 Mar 2016 22:59:19 GMT</pubDate>
            <description><![CDATA[说说这个站点是如何添加"Fork me on Github",如果只是简单的添加只需要参考github的文档,]]></description>
            <content:encoded><![CDATA[<p>说说这个站点是如何添加"Fork me on Github",如果只是简单的添加只需要参考<a href="https://github.com/blog/273-github-ribbons" target="_blank" rel="noopener noreferrer">github的文档</a>,
将类似下面的代码添加到主题文件夹下<code>layout</code>文件夹下的<code>_layout.swig</code>文件中</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">a</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">https://github.com/you</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">img</span><span class="token tag" style="color:#22863A"> </span><span class="token tag special-attr attr-name" style="color:#0550AE">style</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">"</span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">position</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> absolute</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">top</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#005CC5">0</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">left</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#005CC5">0</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">border</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#005CC5">0</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">alt</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">Fork me on GitHub</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">data-canonical-src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>比如我的<code>github</code>地址为:<code>https://github.com/dannyjiajia</code>
所以上面的代码改为:</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">a</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">https://github.com/dannyjiajia</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">img</span><span class="token tag" style="color:#22863A"> </span><span class="token tag special-attr attr-name" style="color:#0550AE">style</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">"</span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">position</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> absolute</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">top</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#005CC5">0</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">left</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#005CC5">0</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css property" style="color:#005CC5">border</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">:</span><span class="token tag special-attr attr-value value css language-css" style="color:#C6105F"> </span><span class="token tag special-attr attr-value value css language-css number" style="color:#005CC5">0</span><span class="token tag special-attr attr-value value css language-css punctuation" style="color:#393A34">;</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">alt</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">Fork me on GitHub</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name" style="color:#0550AE">data-canonical-src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#C6105F">https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#22863A">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>但是这样会有个问题：手机上的页面也会是这个效果,其他主题不知道，<code>next</code>主题会把页面的导航菜单给挡住。我这里采取的方式是只在<code>桌面版</code>的页面上添加。</strong></p>
<p><del>修改<code>/themes/next/source/js/src/schemes/pisces.js</code></del>
其实可以统一修改这个文件:<code>/themes/next/source/js/src/motion.js</code></p>
<p>在<code>$(document).ready</code>函数内添加如下代码</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">NexT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#8250DF">isDesktop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token dom variable" style="color:#E36209">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#8250DF">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">'这里粘贴你修改后的html代码'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>over~ 这样就只会在桌面版的网页内显示"Fork me on Github"</p>]]></content:encoded>
            <category>Next</category>
        </item>
        <item>
            <title><![CDATA[最简单的方法将iOS中的NSLog写入文件]]></title>
            <link>https://dannyjiajia.github.io/2016/simple-write-ios-log</link>
            <guid>https://dannyjiajia.github.io/2016/simple-write-ios-log</guid>
            <pubDate>Sun, 31 Jan 2016 17:05:29 GMT</pubDate>
            <description><![CDATA[~~~objectivec]]></description>
            <content:encoded><![CDATA[<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">ifdef</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">DEBUG</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> redirectConsoleLogToDocumentFolder </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSArray </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">paths </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">NSSearchPathForDirectoriesInDomains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">NSDocumentDirectory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> NSUserDomainMask</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> YES</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSString </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">documentsDirectory </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">paths objectAtIndex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSString </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">logPath </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">documentsDirectory stringByAppendingPathComponent</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#C6105F">@"iOS.log"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">freopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">logPath cStringUsingEncoding</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">NSUTF8StringEncoding</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#C6105F">"a+"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token constant" style="color:#005CC5">stderr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSDateFormatter </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">formatter </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSDateFormatter alloc</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">formatter setDateFormat</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#C6105F">@"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NSString </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">time </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">formatter stringFromDate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">NSDate date</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">NSLog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">@"-------------- Start Log [%@] --------------"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">formatter release</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在程序启动的时候调用即可,所有的NSLog日志都会记录到documents下的iOS.log内</p>
<div class="language-objectivec codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-objectivec codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">ifdef</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">DEBUG</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#CF222E">self</span><span class="token plain"> redirectConsoleLogToDocumentFolder</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>iOS</category>
        </item>
        <item>
            <title><![CDATA[如何在window phone控制屏幕常亮]]></title>
            <link>https://dannyjiajia.github.io/2016/request-display-always-in-wp</link>
            <guid>https://dannyjiajia.github.io/2016/request-display-always-in-wp</guid>
            <pubDate>Sun, 31 Jan 2016 16:54:42 GMT</pubDate>
            <description><![CDATA[在WindowPhone下禁用锁屏的事件]]></description>
            <content:encoded><![CDATA[<p>在WindowPhone下禁用锁屏的事件</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="定义工具类">定义工具类<a href="https://dannyjiajia.github.io/2016/request-display-always-in-wp#%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7%E7%B1%BB" class="hash-link" aria-label="定义工具类的直接链接" title="定义工具类的直接链接">​</a></h3>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">public</span><span class="token plain"> ref </span><span class="token keyword" style="color:#CF222E">class</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">Device</span><span class="token plain"> sealed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">private</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#8250DF">Device</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> m_requestActivd </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Windows</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">System</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Display</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">DisplayRequest</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> m_display_request</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> m_requestActivd</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">public</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">DisplayRequestActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m_requestActivd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//如果重复调用会抛出错误</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">nullptr</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> m_display_request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m_display_request </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> ref </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> Windows</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">System</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token class-name" style="color:#116329">Display</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">DisplayRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m_display_request</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">RequestActive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m_requestActivd </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">DisplayRequestRelease</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain">m_requestActivd</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">nullptr</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> m_display_request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m_display_request</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">RequestRelease</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m_requestActivd </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> property Device</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> Instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Device</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> Device</span><span class="token operator" style="color:#D73A49">^</span><span class="token plain"> instance </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> ref </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">Device</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用">使用<a href="https://dannyjiajia.github.io/2016/request-display-always-in-wp#%E4%BD%BF%E7%94%A8" class="hash-link" aria-label="使用的直接链接" title="使用的直接链接">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//屏幕常亮</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device::Instance-&gt;DisplayRequestActive();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//关闭屏幕常亮</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Device::Instance-&gt;DisplayRequestRelease();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>over~~</p>]]></content:encoded>
            <category>Windows Phone</category>
            <category>Windows Mobile</category>
        </item>
    </channel>
</rss>