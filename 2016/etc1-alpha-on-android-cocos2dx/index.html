<!doctype html>
<html lang="zh-Hans" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Cocos2dx使用ETC1+Alpha压缩纹理 | Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://dannyjiajia.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://dannyjiajia.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Cocos2dx使用ETC1+Alpha压缩纹理 | Notes"><meta data-rh="true" name="description" content="我们为了优化游戏的内存占用,会给图片资源进行有损压缩,在Android上则是使用ETC1(Ericsson texture compression)进行纹理压缩,压缩纹理无论从加载速度(GPU识别)和内存占用都有很大的优势,唯一的缺点就是有损。"><meta data-rh="true" property="og:description" content="我们为了优化游戏的内存占用,会给图片资源进行有损压缩,在Android上则是使用ETC1(Ericsson texture compression)进行纹理压缩,压缩纹理无论从加载速度(GPU识别)和内存占用都有很大的优势,唯一的缺点就是有损。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2016-07-15T13:41:42.000Z"><meta data-rh="true" property="article:tag" content="zlib,Cocos2dx,Android,ETC,Optimize"><link data-rh="true" rel="canonical" href="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx"><link data-rh="true" rel="alternate" href="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx","mainEntityOfPage":"https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx","url":"https://dannyjiajia.github.io/2016/etc1-alpha-on-android-cocos2dx","headline":"Cocos2dx使用ETC1+Alpha压缩纹理","name":"Cocos2dx使用ETC1+Alpha压缩纹理","description":"我们为了优化游戏的内存占用,会给图片资源进行有损压缩,在Android上则是使用ETC1(Ericsson texture compression)进行纹理压缩,压缩纹理无论从加载速度(GPU识别)和内存占用都有很大的优势,唯一的缺点就是有损。","datePublished":"2016-07-15T13:41:42.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://dannyjiajia.github.io/","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Notes Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.0f4ec1d6.css">
<script src="/assets/js/runtime~main.fee62a19.js" defer="defer"></script>
<script src="/assets/js/main.994c690b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Notes" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="Notes" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Notes</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/2016/etc1-alpha-on-android-cocos2dx" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li></ul></div><a href="https://github.com/dannyjiajia/dannyjiajia.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="最近博文导航"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/03/12/transformer-task">Transformer 网络及任务分类</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/03/05/deepseek-r1-distill-function-call-fine-tune">微调deepseek-r1蒸馏版工具调用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/02/27/docker-compose-files">多个docker-compose配置的管理思路</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/02/22/docker-proxy-pull">docker通过代理pull镜像</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/02/22/git-cookbook">git使用技巧汇总</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2025/02/22/hello-docusaurus">迁移文档到 Docusaurus</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2017</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2017/think-about-storio">介绍下StorIOSQLite到RxJava</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2017/login-with-curl">2017开篇:curl使用备忘</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2016</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/autopackage">不同平台下的项目自动打包方式</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/thinking-core-graphics">说说Core Graphics</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/thinking-about-macro">以ABS宏为例说说Clang中的宏定义方式技巧</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/findWay">用Lua实现A*寻路算法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/multiline-textbox-wp8-1">WindowsPhone的TextBox多行支持及疑问</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/2016/etc1-alpha-on-android-cocos2dx">Cocos2dx使用ETC1+Alpha压缩纹理</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/think-about-scrollview">quick的ScrollView随想</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/matrix-ios-and-opengl.mdx">Core Graphics和OpenGL里的矩阵运算</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/cpp-convert-string-to-guid">(cpp)cx中将string转换成GUID</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/gcd-and-runloop">GCD与RunLoop</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/calculate-git-changed-file-size">如何计算git变动的文件大小</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/sublime_crack">Sublime Text 3 License Key - CRACK</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/about-rsync">rsync在Windows上的权限问题</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/think-about-android-gradle">对Android的Gradle插件的理解</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/github-link-with-next">谈谈next主题如何添加&quot;Fork me on Github&quot;</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/simple-write-ios-log">最简单的方法将iOS中的NSLog写入文件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/request-display-always-in-wp">如何在window phone控制屏幕常亮</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2016/use-ant-in-gradle">ant插件Antenna实现java代码宏编译</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2015</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2015/how-to-copy-file-in-cmake">如何在cmake里引用动态库的dll文件</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2015/python-logging">Python打印的一个例子</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2015/simple-foreach-lua-string">lua简单遍历字符串字符</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2015/visual-studio">Visual Studio相关</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Cocos2dx使用ETC1+Alpha压缩纹理</h1><div class="container_mt6G margin-vert--md"><time datetime="2016-07-15T13:41:42.000Z">2016年7月15日</time> · <!-- -->阅读需 11 分钟</div></header><div id="__blog-post-container" class="markdown"><p>我们为了优化游戏的内存占用,会给图片资源进行<code>有损压缩</code>,在Android上则是使用<code>ETC1</code>(Ericsson texture compression)进行纹理压缩,压缩纹理无论从加载速度(GPU识别)和内存占用都有很大的优势,唯一的缺点就是有损。
也就是它不是<code>万金油</code>,并不是所有的图片都能使用<code>ETC1</code>压缩。我在记录下我是如何在<code>Cocos2dx</code>中使用<code>ETC1</code>进行纹理压缩.当然这里是在<code>android</code>平台下使用。</p>
<p>ETC1格式是OpenGL ES图形标准的一部分，并且被所有的Android设备所支持,不支持透明通道。需要是POT纹理。虽然后面的<code>ETC2</code>支持透明通道,但是它是<code>OpenGL 3.0</code>的标准，并不能被所有Android设备所支持，而<code>ETC1</code>我们能通过技术手段加入透明通道。参考这篇<a href="http://malideveloper.arm.com/resources/sample-code/etcv1-texture-compression-and-alpha-channels/" target="_blank" rel="noopener noreferrer">文章</a></p>
<h1>之前的准备</h1>
<p><img decoding="async" loading="lazy" src="http://malideveloper.arm.com/wp-content/uploads/2010/09/sample_code_alpha_seperate.jpg" alt="ETC1" class="img_ev3q"></p>
<p>我采用将一张纹理分割成两张图的方案,也就是<code>图片 = RGB部分纹理+Alpha部分纹理</code>。因为纹理大小由于硬件和操作系统原因是有限制的,<code>2048x2048</code>基本能被主流设备所认同，如果采用Alpha拼接的方式,原本2048的纹理最终大小会超过2048,如果所有纹理加上最大尺寸1024的限制又会使纹理数量增多.所以最终我选择了分割图片的方案。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="imagemagick">ImageMagick<a href="#imagemagick" class="hash-link" aria-label="ImageMagick的直接链接" title="ImageMagick的直接链接">​</a></h2>
<p>使用<a href="http://www.imagemagick.org/script/index.php" target="_blank" rel="noopener noreferrer">ImageMagick</a>来分割纹理的RGB和Alpha部分,为什么没有用<code>Mali GPU Texture Compression</code>直接生成呢?因为它生成的最终的<code>pkm</code>文件是经过压缩的,压缩率并不理想。所以后面我会介绍我使用<code>zlib</code>来压缩生成的<code>ETC1</code>格式的纹理。</p>
<p>分离RGB部分</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">convert logo.png </span><span class="token parameter variable" style="color:#E36209">-alpha</span><span class="token plain"> Off logo_rgb.png </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>分离Alpha部分</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">convert logo.png </span><span class="token parameter variable" style="color:#E36209">-channel</span><span class="token plain"> A </span><span class="token parameter variable" style="color:#E36209">-alpha</span><span class="token plain"> extract logo_a.png </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pvrtextool">PVRTexTool<a href="#pvrtextool" class="hash-link" aria-label="PVRTexTool的直接链接" title="PVRTexTool的直接链接">​</a></h2>
<p>使用<a href="https://community.imgtec.com/developers/powervr/tools/pvrtextool/" target="_blank" rel="noopener noreferrer">PVRTexTool</a>压缩ETC1纹理,注意这里生成的文件的后缀是<code>pvr</code>，其实它的格式是<code>ETC1</code></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PVRTexTool </span><span class="token parameter variable" style="color:#E36209">-f</span><span class="token plain"> ETC1 </span><span class="token parameter variable" style="color:#E36209">-i</span><span class="token plain"> logo_rgb.png </span><span class="token parameter variable" style="color:#E36209">-o</span><span class="token plain"> logo_rgb.pvr </span><span class="token parameter variable" style="color:#E36209">-q</span><span class="token plain"> etcfast</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PVRTexTool </span><span class="token parameter variable" style="color:#E36209">-f</span><span class="token plain"> ETC1 </span><span class="token parameter variable" style="color:#E36209">-i</span><span class="token plain"> logo_a.png </span><span class="token parameter variable" style="color:#E36209">-o</span><span class="token plain"> logo_a.pvr </span><span class="token parameter variable" style="color:#E36209">-q</span><span class="token plain"> etcfast</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在<code>logo_rgb.pvr</code>和<code>logo_a.pvr</code>已经是我们需要的<code>ETC1</code>格式的纹理了,但是你会发现它们比转换之前的文件大小大了很多:(
不能增加我们的包大小是不?所以我们先使用<code>zlib</code>来压缩下他们,为什么使用<code>zlib</code>? 因为2dx里已经有<code>zlib</code>库(记得iOS里的<code>xx.pvr</code>和<code>xx.pvr.ccz</code>吧,ccz其实就被zlib压缩过后的<code>PVRTC4</code>纹理),我们不用引入其他库,偷个懒:),当然我们也可以使用其他压缩算法，比如<code>梦幻西游</code>。听他们的开发说,使用的是<code>lzma</code>解压资源,但是它的解压速度会稍慢,但是压缩率比较高,这就需要你自己取舍了。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="压缩纹理">压缩纹理<a href="#压缩纹理" class="hash-link" aria-label="压缩纹理的直接链接" title="压缩纹理的直接链接">​</a></h2>
<blockquote>
<p>我们需要一个工具,他能将纹理使用zlib压缩成一个2dx能识别的压缩格式,或者我们能在代码里能识别的文件.</p>
</blockquote>
<p>我们可以仿照pvr.ccz的策略,修改我们最终生成压缩文件的文件头信息,告诉2dx使用zlib来解压它。定义一个8个字节的结构体，表示我们的头信息.cpp中的结构体是连续的内存分配:)</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>前四个char分别为<code>!</code>,<code>E</code>,<code>T</code>,<code>C</code>,后面的<code>int</code>用来存储文件的原始大小。</p>
<p>最终的源码如下:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//  CompressETCTexture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//  Created by DannyHe on 9/16/15.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//  Copyright (c) 2015 DannyHe. All rights reserved.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#6B6B6B;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#C6105F">&quot;ETCCompress.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#C6105F">&lt;iostream&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">include</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property string" style="color:#C6105F">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">using</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">namespace</span><span class="token plain"> std</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompress</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">compressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ZipHeaderInfo zipHeader</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> inFile </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;rb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_END</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">ftell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> fileData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">&#x27;!&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">&#x27;E&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">&#x27;T&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token char">&#x27;C&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf destLength </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">compressBound</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pDestBuf </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> Bytef</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destLength</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> result </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">compress2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pDestBuf </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">destLength</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">fileData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#005CC5">9</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> Z_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_MEM_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;ETCCompress:: note enough memory for compression&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_BUF_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;ETCCompress:: note enough room in buffer to compress the data&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;ETCCompress:: orignal size: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> fileSize </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; bytes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; , compressed size : &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> destLength </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; bytes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; , header size: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; bytes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; , final size : &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> destLength </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; bytes&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; , compress ratio:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#005CC5">1</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">double</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> destLength</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">/</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">*</span><span class="token number" style="color:#005CC5">100</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;%&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token char">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> fo </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;wb+&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">zipHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pDestBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">destLength</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">delete</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pDestBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">uLongf </span><span class="token class-name" style="color:#116329">ETCCompress</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">unCompressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> packData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> packSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">buff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipHeaderInfo</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> packData</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;!&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;E&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;T&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;C&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;\nETCCompress:: header error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> orginSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> headerSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf newSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> orginSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pUnBuf </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> Bytef</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">newSize</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> result2 </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">uncompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pUnBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">newSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">packData </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> headerSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">packSize </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> headerSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result2 </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> Z_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_MEM_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;ETCCompress:: note enough memory for uncompression&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#CF222E">case</span><span class="token plain"> Z_BUF_ERROR</span><span class="token operator" style="color:#D73A49">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;ETCCompress:: note enough room in buffer to uncompress the data&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#CF222E">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buff </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> pUnBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cout </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;orignal size: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> packSize </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; bytes&quot;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; , ucompressed size : &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> orginSize </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot; bytes&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;&lt;</span><span class="token plain"> </span><span class="token char">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> newSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompress</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">unCompressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> packFile </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srcpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;rb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_END</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> packSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">ftell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> packData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">new</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">packSize</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#005CC5">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> packSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> packFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> pUnBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf newSize </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">unCompressETC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">packSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">pUnBuf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newSize </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;\nETCCompress:: uncompress error!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FILE</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> ft </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">destpath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#C6105F">&quot;wb+&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ft</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fwrite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pUnBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">newSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ft</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ft</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">delete</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> pUnBuf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>更多详细的代码及编译可以看我之前的<a href="http://dannyhe.wang/2015/12/15/how-to-copy-file-in-cmake/" target="_blank" rel="noopener noreferrer">这篇文章</a>和<a href="https://github.com/dannyjiajia/ETCCompress" target="_blank" rel="noopener noreferrer">仓库</a>
然后我们使用我们写的工具压缩我们的纹理</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CompressETCTexture pack logo_rgb.pvr logo_rgb.png</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CompressETCTexture pack logo_a.pvr logo_a.png</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后我们得到两个文件<code>logo_rgb.png</code>和<code>logo_a.png</code>,这两个文件经过了<code>ETC1</code>压缩并且文件大小也是我们能接受的范围,然后我们需要在<code>Cocos2dx</code>中使用他们。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2dx3x中解压">2dx(3.x)中解压<a href="#2dx3x中解压" class="hash-link" aria-label="2dx(3.x)中解压的直接链接" title="2dx(3.x)中解压的直接链接">​</a></h2>
<p>我们在<code>ZipUtils</code>类中加入我们的解压逻辑
头文件<code>ZipUtils.h</code>中声明我们的头信息结构体和解压函数</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">isETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">static</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">inflateETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实现解压</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">bool</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">static_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name" style="color:#116329">size_t</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token boolean" style="color:#005CC5">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;!&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;E&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;T&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;&amp;</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">sig</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#005CC5">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">==</span><span class="token plain"> </span><span class="token char">&#x27;C&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ssize_t bufferLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">struct</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ETCCompressedHeader</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> len </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> header</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token plain">fileSize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#8250DF">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> len </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">!</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">CCLOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;cocos2d: ETCCompressed: Failed to allocate memory for texture&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uLongf destlen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">int</span><span class="token plain"> ret </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">uncompress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">destlen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Bytef</span><span class="token operator" style="color:#D73A49">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">buffer </span><span class="token operator" style="color:#D73A49">+</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bufferLen </span><span class="token operator" style="color:#D73A49">-</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> ret </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> Z_OK </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">CCLOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;cocos2d: ETCCompressed: Failed to uncompress data&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain">out </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">-</span><span class="token number" style="color:#005CC5">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">return</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后我们在2dx读取纹理文件的地方(<code>Image::initWithImageData</code>)调用我们的解压函数</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">if</span><span class="token macro property" style="color:#005CC5"> </span><span class="token macro property expression" style="color:#005CC5">CC_USE_ETC1_ZLIB</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#8250DF">CCLOG</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;Image: Use our etc format compressed!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> etcUnpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">nullptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ssize_t etcUnpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token number" style="color:#005CC5">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcUnpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateETCCompressedBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//detecgt and unzip the compress file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isGZipBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> etcUnpackedLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData </span><span class="token operator" style="color:#D73A49">!=</span><span class="token plain"> unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#8250DF">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etcUnpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//detecgt and unzip the compress file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isGZipBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//detecgt and unzip the compress file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateCCZBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">isGZipBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">ZipUtils</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">inflateMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#D73A49">&amp;</span><span class="token plain">unpackedData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedData </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token generic-function function" style="color:#8250DF">const_cast</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&lt;</span><span class="token generic-function generic class-name keyword" style="color:#CF222E">unsigned</span><span class="token generic-function generic class-name" style="color:#116329"> </span><span class="token generic-function generic class-name keyword" style="color:#CF222E">char</span><span class="token generic-function generic class-name operator" style="color:#D73A49">*</span><span class="token generic-function generic class-name operator" style="color:#D73A49">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unpackedLen </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> dataLen</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#005CC5">#</span><span class="token macro property directive keyword" style="color:#CF222E">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>2dx中使用ETC1</h1>
<p>我使用Shader来操作最中的Alpha,比如在<code>CCSprite</code>中，发现自己使用的纹理是<code>ETC1</code>格式便去查找Alpha纹理，如果发现便使用自己的Shader替换默认的Shader.
这样就做到对游戏以前的开发逻辑毫无修改。因为运用Shader的方式比较多，我这里就只列出我的Shader代码(CCSprite)</p>
<p>顶点不需要修改默认的</p>
<div class="language-glsl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glsl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> ccShader_etc1_PositionTextureColor_noMVP_vert </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">STRINGIFY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">attribute</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> a_position</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">attribute</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec2</span><span class="token plain"> a_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">attribute</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> a_color</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> v_fragmentColor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec2</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gl_Position </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> CC_PMatrix </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> a_position</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_fragmentColor </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> a_color</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v_texCoord </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> a_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>片段着色</p>
<div class="language-glsl codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-glsl codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">// u_texture1是etc的alpha数据也可以用ETC1压缩</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">const</span><span class="token plain"> char</span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> ccShader_etc1_PositionTextureColor_noMVP_frag </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">STRINGIFY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">\n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> v_fragmentColor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">varying</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">vec2</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">uniform</span><span class="token plain"> </span><span class="token keyword" style="color:#CF222E">sampler2D</span><span class="token plain"> u_texture1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">void</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#CF222E">vec4</span><span class="token plain"> color </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">texture2D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CC_Texture0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    color</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token function" style="color:#8250DF">texture2D</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u_texture1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v_texCoord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gl_FragColor </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> color </span><span class="token operator" style="color:#D73A49">*</span><span class="token plain"> v_fragmentColor</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//支持Cocos opacity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用的话大概只需这样</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> program </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">GLProgramCache</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">getInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">getGLProgram</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GLProgram</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">SHADER_NAME_ETC_ALPHA_POSITION_TEXTURE_COLOR_NO_MVP</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#6B6B6B;font-style:italic">//新加的etc shader</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#CF222E">auto</span><span class="token plain"> etc_program_state </span><span class="token operator" style="color:#D73A49">=</span><span class="token plain"> </span><span class="token class-name" style="color:#116329">GLProgramState</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#8250DF">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">program</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">etc_program_state</span><span class="token operator" style="color:#D73A49">-&gt;</span><span class="token function" style="color:#8250DF">setUniformTexture</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#C6105F">&quot;u_texture1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> texture_alpha</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#8250DF">setGLProgramState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">etc_program_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>最后</h1>
<p>如果还需要优化包大小,可以采用将PNG转换成两张JPG,也是RGB+ALPHA.<code>刀塔传奇</code>就有使用这种策略。我们还可以直接压缩<code>png</code>,使它的画质降低,比如<a href="https://pngquant.org/" target="_blank" rel="noopener noreferrer">pngquant</a></p>
<p>另外上文中我们zlib压缩文件的小工具也可以来压缩其他文件,比如我们在<code>Windows Phone</code>平台使用的压缩纹理<code>DXT3</code>...
在发布<code>Android</code>的时候我们同样需要声明我们的游戏使用ETC压缩</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#6B6B6B;font-style:italic">&lt;!-- we want the device support etc1 texture format --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#22863A">supports-gl-texture</span><span class="token tag" style="color:#22863A"> </span><span class="token tag attr-name namespace" style="color:#0550AE;opacity:0.7">android:</span><span class="token tag attr-name" style="color:#0550AE">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#C6105F">GL_OES_compressed_ETC1_RGB8_texture</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#22863A"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/zlib">zlib</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/cocos-2-dx">Cocos2dx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/android">Android</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/etc">ETC</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/optimize">Optimize</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="博文分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/2016/multiline-textbox-wp8-1"><div class="pagination-nav__sublabel">较新一篇</div><div class="pagination-nav__label">WindowsPhone的TextBox多行支持及疑问</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2016/think-about-scrollview"><div class="pagination-nav__sublabel">较旧一篇</div><div class="pagination-nav__label">quick的ScrollView随想</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#imagemagick" class="table-of-contents__link toc-highlight">ImageMagick</a></li><li><a href="#pvrtextool" class="table-of-contents__link toc-highlight">PVRTexTool</a></li><li><a href="#压缩纹理" class="table-of-contents__link toc-highlight">压缩纹理</a></li><li><a href="#2dx3x中解压" class="table-of-contents__link toc-highlight">2dx(3.x)中解压</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2015 - 2025 Notes, Inc.</div></div></div></footer></div>
</body>
</html>